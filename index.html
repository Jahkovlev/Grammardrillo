<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grammardrillo - English Grammar Drill</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 28px;
        }

        h2 {
            color: #555;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .welcome-text {
            font-size: 20px;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .menu-button {
            display: block;
            width: 100%;
            margin-bottom: 15px;
            background: #48bb78;
        }

        .menu-button:hover {
            background: #38a169;
        }
        
        .category-button {
            display: block;
            width: 100%;
            margin-bottom: 15px;
            background: #4299e1;
        }
        
        .category-button:hover {
            background: #3182ce;
        }

        .back-button {
            background: #f56565;
            padding: 10px 20px;
            font-size: 16px;
        }

        .back-button:hover {
            background: #e53e3e;
        }

        .navigation-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }

        .button-row {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 350px;
        }
        
        .navigation-buttons .back-button {
            margin-top: 10px;
        }

        .nav-button {
            background: #4299e1;
            padding: 10px 25px;
            font-size: 16px;
        }

        .nav-button:hover {
            background: #3182ce;
        }

        .exercise-container {
            background: #f7fafc;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .exercise-container:hover {
            background: #edf2f7;
        }
        
        .exercise-container::after {
            content: 'Клик, чтобы скрыть/показать примеры';
            position: absolute;
            bottom: 5px;
            right: 10px;
            font-size: 12px;
            color: #a0aec0;
            font-style: italic;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .exercise-container:hover::after {
            opacity: 1;
        }

        .article-exercise-container {
            background: #f7fafc;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .article-exercise-container:hover {
            background: #edf2f7;
        }
        
        .article-exercise-container::after {
            content: 'Клик, чтобы увидеть ответ';
            position: absolute;
            bottom: 5px;
            right: 10px;
            font-size: 12px;
            color: #a0aec0;
            font-style: italic;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        #avstheContainer::after {
            content: 'Клик, чтобы увидеть второе предложение';
            position: absolute;
            bottom: 5px;
            right: 10px;
            font-size: 12px;
            color: #a0aec0;
            font-style: italic;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        #avstheContainer.answered::after {
            content: 'Сравните использование артиклей';
            color: #48bb78;
        }
        
        .article-exercise-container:hover::after {
            opacity: 1;
        }

        .article-exercise-container.answered::after {
            content: 'Ответ показан';
            color: #48bb78;
        }

        .sentence {
            font-size: 20px;
            color: #2d3748;
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .sentence:hover {
            border-color: #667eea;
            transform: translateX(5px);
        }

        .article-sentence {
            font-size: 22px;
            color: #2d3748;
            background: white;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
            padding: 20px;
            line-height: 1.5;
            text-align: center;
        }

        .article-sentence.task {
            border-color: #4299e1;
            background: #ebf8ff;
        }

        .article-sentence.answer {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .exercise-title {
            font-size: 16px;
            color: #718096;
            margin-bottom: 20px;
            font-style: italic;
            line-height: 1.5;
        }
        
        #testInstructions:hover,
        #exerciseSubtitle:hover,
        #articleInstructions:hover {
            text-decoration: underline;
            color: #4a5568;
        }

        .hidden {
            display: none;
        }

        .verb-info {
            background: #bee3f8;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: bold;
            color: #2c5282;
            line-height: 1.6;
            text-align: center;
        }

        .article-info {
            background: #c6f6d5;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: bold;
            color: #22543d;
            line-height: 1.6;
            text-align: center;
        }

        .rules-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }

        .rules-button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #f56565;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: #e53e3e;
            transform: scale(1.1);
        }

        .modal-title {
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-description {
            font-size: 16px;
            line-height: 1.6;
            color: #555;
            cursor: pointer;
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
            transition: all 0.3s ease;
            user-select: none;
            position: relative;
        }

        .modal-description:hover {
            background: #e2e8f0;
        }

        .modal-description:after {
            content: '🔄 Click to switch language';
            position: absolute;
            bottom: -20px;
            right: 0;
            font-size: 12px;
            color: #718096;
            font-style: italic;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #e53e3e;
            font-size: 14px;
            margin-top: 10px;
            padding: 10px;
            background: #fed7d7;
            border-radius: 8px;
        }

        .nav-button.next-button {
            background: #48bb78;
        }
        
        .nav-button.next-button:hover {
            background: #38a169;
        }
        
        .russian {
            font-size: 28px;
            color: #5a67d8;
            font-weight: bold;
            margin-bottom: 20px;
            padding: 30px 20px 20px 20px;
            background: #e6f2ff;
            border-radius: 10px;
            text-align: center;
            display: block !important;
            position: relative;
        }
        
        .tense-badge {
            position: absolute;
            top: -15px;
            right: 20px;
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: normal;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            animation: badgeAppear 0.5s ease-out;
            cursor: default;
            user-select: none;
        }
        
        @keyframes badgeAppear {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-10px);
            }
            50% {
                transform: scale(1.1) translateY(0);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .tense-badge:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5);
        }
        
        .tense-badge.present { background: #48bb78; }
        .tense-badge.present:hover { box-shadow: 0 4px 15px rgba(72, 187, 120, 0.5); }
        
        .tense-badge.past { background: #f56565; }
        .tense-badge.past:hover { box-shadow: 0 4px 15px rgba(245, 101, 101, 0.5); }
        
        .tense-badge.future { background: #4299e1; }
        .tense-badge.future:hover { box-shadow: 0 4px 15px rgba(66, 153, 225, 0.5); }
        
        .tense-badge.present-perfect { background: #9f7aea; }
        .tense-badge.present-perfect:hover { box-shadow: 0 4px 15px rgba(159, 122, 234, 0.5); }
        
        .tense-badge.past-perfect { background: #ed8936; }
        .tense-badge.past-perfect:hover { box-shadow: 0 4px 15px rgba(237, 137, 54, 0.5); }
        
        .tense-badge.present-continuous { background: #38b2ac; }
        .tense-badge.present-continuous:hover { box-shadow: 0 4px 15px rgba(56, 178, 172, 0.5); }
        
        .tense-badge.past-continuous { background: #e53e3e; }
        .tense-badge.past-continuous:hover { box-shadow: 0 4px 15px rgba(229, 62, 62, 0.5); }
        
        .tense-badge.future-continuous { background: #3182ce; }
        .tense-badge.future-continuous:hover { box-shadow: 0 4px 15px rgba(49, 130, 206, 0.5); }
        
        .tense-badge.present-perfect-continuous { background: #805ad5; }
        .tense-badge.present-perfect-continuous:hover { box-shadow: 0 4px 15px rgba(128, 90, 213, 0.5); }
        
        .tense-badge.past-perfect-continuous { background: #dd6b20; }
        .tense-badge.past-perfect-continuous:hover { box-shadow: 0 4px 15px rgba(221, 107, 32, 0.5); }
        
        .english {
            font-size: 22px;
            color: #2d3748;
            margin: 10px 0;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            transition: all 0.3s ease;
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }
        
        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }
        
        .test-item {
            cursor: pointer;
            user-select: none;
            width: 100%;
        }
        
        #testContainer {
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        #testContainer:after {
            content: 'Клик для ответа';
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 14px;
            color: #a0aec0;
            font-style: italic;
        }
        
        #testContainer.complete:after {
            content: 'Готово! Попробуй новый пример';
        }
        
        .exercise-screen {
            /* Common styling for all exercise screens */
        }

        /* Audio status indicator */
        .audio-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #48bb78;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            opacity: 1;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            user-select: none;
            max-width: 200px;
            text-align: center;
            border: 2px solid transparent;
        }

        .audio-status:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border-color: rgba(255,255,255,0.3);
        }

        .audio-status.disabled {
            background: #f56565;
            animation: pulse 2s ease-in-out infinite;
        }

        .audio-status.disabled:hover {
            background: #e53e3e;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 2px 10px rgba(245, 101, 101, 0.3);
            }
            50% {
                box-shadow: 0 4px 20px rgba(245, 101, 101, 0.6);
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 20px;
            }
            
            button {
                padding: 12px 25px;
                font-size: 16px;
            }
            
            .navigation-buttons {
                justify-content: center;
            }
            
            .nav-button {
                margin: 5px;
            }
            
            .tense-badge {
                animation: badgeAppear 0.5s ease-out, pulseMobile 2s ease-in-out infinite;
                font-size: 12px;
                padding: 4px 12px;
            }
            
            .russian {
                font-size: 24px;
                padding: 35px 15px 15px 15px;
            }
        }
        
        @keyframes pulseMobile {
            0%, 100% {
                box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
            }
            50% {
                box-shadow: 0 2px 20px rgba(102, 126, 234, 0.6);
            }
        }
        
        @keyframes drillPulse {
            0%, 100% {
                transform: scaleY(1.1) scale(1);
                filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
            }
            50% {
                transform: scaleY(1.1) scale(1.08);
                filter: drop-shadow(3px 3px 6px rgba(0,0,0,0.4));
            }
        }
    </style>
</head>
<body>
    <!-- ResponsiveVoice fallback for mobile speech synthesis -->
    <script src="https://code.responsivevoice.org/responsivevoice.js?key=FREE"></script>
    
    <!-- Audio status indicator -->
    <div id="audioStatus" class="audio-status" title="Click for audio debug information">🔊 Loading Audio...</div>

    <div class="container">
        <!-- Welcome Screen -->
        <div id="welcomeScreen" class="screen">
            <h1 style="font-size: 22px; margin-bottom: 10px;">Welcome to <span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 6px;">Grammar</span>drillo!</h1>
            <p class="welcome-text" style="font-size: 42px; font-weight: bold; color: #2d3748; margin: 30px 0;">It's time to <strong style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-family: Impact, Arial Black, sans-serif; font-size: 64px; letter-spacing: 3px; text-shadow: none; display: inline-block; transform: scaleY(1.1); animation: drillPulse 2s ease-in-out infinite; filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));">DRILL</strong></p>
            <p style="font-size: 14px; color: #718096; margin-top: 20px;">✨ Все времена и неправильные глаголы</p>
            <button onclick="app.showMainMenu()">GO!</button>
        </div>

        <!-- Main Menu -->
        <div id="mainMenu" class="screen hidden">
            <h1>Main Menu</h1>
            <button class="menu-button" onclick="app.showExercises()">Exercises</button>
            <button class="menu-button" onclick="app.showTestYourself()">Test Yourself</button>
        </div>

        <!-- Exercises Menu -->
        <div id="exercisesMenu" class="screen hidden">
            <h2>Choose Category</h2>
            <button class="category-button" onclick="app.showSimpleMenu()">Simple Tenses</button>
            <button class="category-button" onclick="app.showContinuousMenu()">Continuous Tenses</button>
            <button class="category-button" onclick="app.startArticleExercise()">Articles (A/An)</button>
            <button class="category-button" onclick="app.startAvsTheExercise()">Articles (A vs The)</button>
            <button class="back-button" onclick="app.showMainMenu()">Back to Main Menu</button>
        </div>
        
        <!-- Simple Tenses Menu -->
        <div id="simpleMenu" class="screen hidden">
            <h2>Simple Tenses</h2>
            <button class="menu-button" onclick="app.startExercise('present')">Present Simple</button>
            <button class="menu-button" onclick="app.startExercise('past')">Past Simple</button>
            <button class="menu-button" onclick="app.startExercise('future')">Future Simple</button>
            <button class="menu-button" onclick="app.startExercise('presentPerfect')">Present Perfect</button>
            <button class="menu-button" onclick="app.startExercise('pastPerfect')">Past Perfect</button>
            <button class="back-button" onclick="app.showExercises()">Back to Categories</button>
        </div>
        
        <!-- Continuous Tenses Menu -->
        <div id="continuousMenu" class="screen hidden">
            <h2>Continuous Tenses</h2>
            <button class="menu-button" onclick="app.startExercise('presentContinuous')">Present Continuous</button>
            <button class="menu-button" onclick="app.startExercise('pastContinuous')">Past Continuous</button>
            <button class="menu-button" onclick="app.startExercise('futureContinuous')">Future Continuous</button>
            <button class="menu-button" onclick="app.startExercise('presentPerfectContinuous')">Present Perfect Continuous</button>
            <button class="menu-button" onclick="app.startExercise('pastPerfectContinuous')">Past Perfect Continuous</button>
            <button class="back-button" onclick="app.showExercises()">Back to Categories</button>
        </div>

        <!-- Universal Exercise Template -->
        <div id="exerciseTemplate" class="screen exercise-screen hidden">
            <h2 id="exerciseTitle">Exercise Title</h2>
            <p class="exercise-title" id="exerciseSubtitle" onclick="app.toggleExerciseInstructions()" style="cursor: pointer;" title="Click to toggle instructions">Next - поменять подлежащее<br>
            Change the Word - поменять глагол<br>
            Клик на примерах, чтобы скрыть всё, кроме утверждения</p>
            
            <div class="verb-info" id="currentVerbInfo">Current verb: go</div>
            <button class="rules-button" onclick="app.showRules()">📚 Rules</button>
            
            <div class="exercise-container" onclick="app.toggleExamples()">
                <div id="sentenceDisplay">
                    <div class="sentence" id="sentence1">Loading...</div>
                    <div class="sentence" id="sentence2">Loading...</div>
                    <div class="sentence" id="sentence3">Loading...</div>
                    <div class="sentence" id="sentence4">Loading...</div>
                </div>
            </div>

            <div id="errorMessage" class="error-message hidden"></div>

            <div class="navigation-buttons">
                <div class="button-row">
                    <button class="nav-button" onclick="app.previousSubject()">◀ Back</button>
                    <button class="nav-button next-button" onclick="app.nextSubject()">Next ▶</button>
                </div>
                <div class="button-row">
                    <button class="nav-button" onclick="app.playAudio()">🔊 Play</button>
                    <button class="nav-button" onclick="app.changeVerb()">Change the Word</button>
                </div>
                <button class="back-button" id="exerciseBackButton" onclick="app.goBack()">Tenses</button>
            </div>
        </div>

        <!-- A vs The Exercise -->
        <div id="avstheExercise" class="screen exercise-screen hidden">
            <h2>Articles (A vs The)</h2>
            <p class="exercise-title" id="avstheInstructions" onclick="app.toggleAvsTheInstructions()" style="cursor: pointer;" title="Click to toggle instructions">Сравните использование "a" и "the"<br>
            Клик на примере для просмотра второго предложения<br>
            Клик на инструкции, чтобы её скрыть<br>
            Next - новый пример</p>
            
            <div class="article-info hidden" id="currentAvsTheInfo"></div>
            <button class="rules-button" onclick="app.showAvsTheRules()">📚 A vs The Rules</button>
            
            <div class="article-exercise-container" id="avstheContainer" onclick="app.revealTheExample()">
                <div class="article-sentence task" id="aExample">Loading...</div>
                <div class="article-sentence answer hidden" id="theExample">Loading...</div>
            </div>

            <div id="avstheErrorMessage" class="error-message hidden"></div>

            <div class="navigation-buttons">
                <button class="nav-button next-button" onclick="app.nextAvsTheExample()">Next Example ▶</button>
                <button class="nav-button" onclick="app.playAvsTheAudio()">🔊 Play</button>
                <button class="back-button" onclick="app.showExercises()">Back to Categories</button>
            </div>
        </div>

        <!-- Article Exercise -->
        <div id="articleExercise" class="screen exercise-screen hidden">
            <h2>Articles (A/An)</h2>
            <p class="exercise-title" id="articleInstructions" onclick="app.toggleArticleInstructions()" style="cursor: pointer;" title="Click to toggle instructions">Решите, нужен ли артикль "a", "an"<br>
            Клик на примере для просмотра ответа<br>
            Клик на инструкции, чтобы её скрыть<br>
            Next - новый пример</p>
            
            <div class="article-info hidden" id="currentArticleInfo"></div>
            <button class="rules-button" onclick="app.showArticleRules()">📚 A/An Rules</button>
            
            <div class="article-exercise-container" id="articleContainer" onclick="app.revealArticleAnswer()">
                <div class="article-sentence task" id="articleTask">Loading...</div>
                <div class="article-sentence answer hidden" id="articleAnswer">Loading...</div>
            </div>

            <div id="articleErrorMessage" class="error-message hidden"></div>

            <div class="navigation-buttons">
                <button class="nav-button next-button" onclick="app.nextArticleExample()">Next Example ▶</button>
                <button class="nav-button" onclick="app.playArticleAudio()">🔊 Play</button>
                <button class="back-button" onclick="app.showExercises()">Back to Categories</button>
            </div>
        </div>

        <!-- Test Yourself -->
        <div id="testYourself" class="screen hidden">
            <h2>Test Yourself</h2>
            <p class="exercise-title" id="testInstructions" onclick="app.toggleInstructions()" style="cursor: pointer;" title="Click to toggle instructions">Составь в заданном времени:<br>
            - Утверждение<br>
            - Отрицание<br>
            - Вопрос<br>
            - Wh-вопрос<br>
            Клик, чтобы проверить себя</p>
            
            <div class="exercise-container" id="testContainer" onclick="app.revealNext()">
                <div class="test-item">
                    <div class="russian" id="russianSentence">Loading...</div>
                    <div class="english hidden" id="englishPositive"></div>
                    <div class="english hidden" id="englishNegative"></div>
                    <div class="english hidden" id="englishQuestion"></div>
                    <div class="english hidden" id="englishWhQuestion"></div>
                </div>
            </div>
            
            <div id="testError" class="error-message hidden"></div>
            
            <div class="navigation-buttons">
                <button class="nav-button" onclick="app.generateNewTest()">New Example</button>
                <button class="back-button" onclick="app.showMainMenu()">Main Menu</button>
            </div>
        </div>
    </div>

    <script>
        // Application State Manager
        const app = {
            // Current state
            currentTense: null,
            currentVerb: 'go',
            currentSubjectIndex: 0,
            isLoading: false,
            audioEnabled: false,
            currentRulesLanguage: 'russian',
            examplesHidden: false,
            
            // Audio state
            audioInitialized: false,
            speechAvailable: false,
            responsiveVoiceAvailable: false,
            currentAudioMethod: null, // 'native', 'responsivevoice', or null
            isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
            
            // Article exercise state
            currentArticleIndex: 0,
            articleAnswerRevealed: false,
            articleInstructionsCollapsed: false,
            availableArticleIndices: [],
            
            // A vs The exercise state
            currentAvsTheIndex: 0,
            avstheAnswerRevealed: false,
            avstheInstructionsCollapsed: false,
            availableAvsTheIndices: [],
            
            // Test state
            revealStage: 0,
            currentTestData: null,
            instructionsCollapsed: false,
            exerciseInstructionsCollapsed: false,
            
            // Navigation history for back button
            navigationHistory: [],
            
            // Initialize
            init() {
                // Set up debug handler first thing
                setTimeout(() => {
                    this.setupAudioDebugHandler();
                }, 100);
                
                this.initializeAudio();
                this.showScreen('welcomeScreen');
            },

            // Initialize audio system with mobile fixes and fallbacks
            initializeAudio() {
                console.log('Initializing audio system with mobile fallbacks...');
                
                // Always set up the debug click handler first
                this.setupAudioDebugHandler();
                
                // Check multiple audio methods
                this.detectAudioMethods();
                
                if (!this.speechAvailable && !this.responsiveVoiceAvailable) {
                    console.log('No audio methods available');
                    this.updateAudioStatus('❌ Click for Help', true);
                    return;
                }

                // Determine which method to use
                this.selectAudioMethod();
                
                console.log(`Using audio method: ${this.currentAudioMethod}`);
                
                // Initialize the selected method
                if (this.currentAudioMethod === 'native') {
                    this.initializeNativeSpeech();
                } else if (this.currentAudioMethod === 'responsivevoice') {
                    this.initializeResponsiveVoice();
                }
            },

            // Detect all available audio methods
            detectAudioMethods() {
                // Check native speech synthesis
                this.speechAvailable = this.detectSpeechSupport();
                
                // Check ResponsiveVoice availability
                this.responsiveVoiceAvailable = this.detectResponsiveVoice();
                
                console.log('Audio methods detected:', {
                    native: this.speechAvailable,
                    responsiveVoice: this.responsiveVoiceAvailable
                });
            },

            // Detect ResponsiveVoice availability
            detectResponsiveVoice() {
                try {
                    // Check if ResponsiveVoice is loaded
                    if (typeof responsiveVoice !== 'undefined' && responsiveVoice) {
                        console.log('ResponsiveVoice detected');
                        return true;
                    }
                } catch (error) {
                    console.log('ResponsiveVoice not available:', error);
                }
                
                // If not immediately available, set up a delayed check
                setTimeout(() => {
                    if (typeof responsiveVoice !== 'undefined' && responsiveVoice) {
                        console.log('ResponsiveVoice loaded after delay');
                        this.responsiveVoiceAvailable = true;
                        
                        // If we don't have native speech, switch to ResponsiveVoice
                        if (!this.speechAvailable || !this.audioInitialized) {
                            this.currentAudioMethod = 'responsivevoice';
                            this.initializeResponsiveVoice();
                        }
                    }
                }, 2000);
                
                return false;
            },

            // Select the best audio method for the current device
            selectAudioMethod() {
                if (this.isMobile) {
                    // On mobile, prefer ResponsiveVoice for reliability
                    if (this.responsiveVoiceAvailable) {
                        this.currentAudioMethod = 'responsivevoice';
                    } else if (this.speechAvailable) {
                        this.currentAudioMethod = 'native';
                    }
                } else {
                    // On desktop, prefer native for performance
                    if (this.speechAvailable) {
                        this.currentAudioMethod = 'native';
                    } else if (this.responsiveVoiceAvailable) {
                        this.currentAudioMethod = 'responsivevoice';
                    }
                }
            },

            // Initialize native speech synthesis
            initializeNativeSpeech() {
                console.log('Initializing native speech synthesis...');
                
                // Initialize speech synthesis on first user interaction
                document.addEventListener('click', this.enableAudioOnFirstClick.bind(this), { once: true });
                document.addEventListener('touchstart', this.enableAudioOnFirstClick.bind(this), { once: true });

                // Handle voices loaded event
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = this.onVoicesChanged.bind(this);
                }

                // Multiple attempts to check for voices
                this.checkVoicesWithRetry(0);

                this.updateAudioStatus('🔊 Tap to Enable Audio', false);
            },

            // Initialize ResponsiveVoice
            initializeResponsiveVoice() {
                console.log('Initializing ResponsiveVoice...');
                
                // ResponsiveVoice doesn't need user interaction on mobile
                if (typeof responsiveVoice !== 'undefined' && responsiveVoice) {
                    this.audioInitialized = true;
                    this.audioEnabled = true;
                    this.updateAudioStatus('🔊 Audio Ready (RV)', false);
                    
                    // Auto-hide after success
                    setTimeout(() => {
                        const statusEl = document.getElementById('audioStatus');
                        if (statusEl) statusEl.style.opacity = '0.3';
                    }, 2000);
                } else {
                    this.updateAudioStatus('🔊 Tap to Enable Audio', false);
                    
                    // Set up user interaction to try again
                    document.addEventListener('click', () => {
                        if (typeof responsiveVoice !== 'undefined' && responsiveVoice && !this.audioInitialized) {
                            this.audioInitialized = true;
                            this.audioEnabled = true;
                            this.updateAudioStatus('🔊 Audio Ready (RV)', false);
                        }
                    }, { once: true });
                }
            },

            // Detect speech synthesis support with multiple methods
            detectSpeechSupport() {
                // Method 1: Check if APIs exist
                if (!('speechSynthesis' in window)) {
                    console.log('speechSynthesis not in window');
                    return false;
                }
                
                if (!('SpeechSynthesisUtterance' in window)) {
                    console.log('SpeechSynthesisUtterance not in window');
                    return false;
                }
                
                // Method 2: Try to create an utterance
                try {
                    const testUtterance = new SpeechSynthesisUtterance();
                    if (!testUtterance) {
                        console.log('Failed to create SpeechSynthesisUtterance');
                        return false;
                    }
                } catch (error) {
                    console.log('Error creating SpeechSynthesisUtterance:', error);
                    return false;
                }
                
                // Method 3: Check if speechSynthesis has required methods
                if (typeof speechSynthesis.speak !== 'function') {
                    console.log('speechSynthesis.speak is not a function');
                    return false;
                }
                
                if (typeof speechSynthesis.getVoices !== 'function') {
                    console.log('speechSynthesis.getVoices is not a function');
                    return false;
                }
                
                console.log('All speech synthesis checks passed');
                return true;
            },

            // Set up the debug click handler - always available
            setupAudioDebugHandler() {
                const statusEl = document.getElementById('audioStatus');
                if (statusEl) {
                    console.log('Setting up audio debug handler');
                    
                    // Remove any existing handlers
                    statusEl.onclick = null;
                    
                    // Add the debug handler
                    statusEl.onclick = (event) => {
                        event.preventDefault();
                        event.stopPropagation();
                        console.log('Audio debug clicked');
                        this.showAudioDebugInfo();
                    };
                    
                    // Make it more obvious it's clickable
                    statusEl.style.cursor = 'pointer';
                    statusEl.title = 'Click for audio debug information';
                    
                    console.log('Audio debug handler set up successfully');
                } else {
                    console.log('Audio status element not found, retrying...');
                    setTimeout(() => {
                        this.setupAudioDebugHandler();
                    }, 500);
                }
            },

            // Check for voices with retry mechanism
            checkVoicesWithRetry(attempt) {
                const voices = speechSynthesis.getVoices();
                console.log(`Voice check attempt ${attempt + 1}:`, voices.length, 'voices found');
                
                if (voices.length > 0) {
                    this.onVoicesChanged();
                    return;
                }
                
                if (attempt < 5) {
                    setTimeout(() => {
                        this.checkVoicesWithRetry(attempt + 1);
                    }, attempt * 200 + 100); // Progressive delay: 100ms, 300ms, 500ms, 700ms, 900ms
                } else {
                    console.log('No voices found after multiple attempts');
                    this.updateAudioStatus('⚠️ No Voices Available', true);
                }
            },

            // Enable audio on first user interaction (required for mobile)
            enableAudioOnFirstClick() {
                console.log('User interaction detected, enabling audio...');
                
                if (!this.audioInitialized && this.speechAvailable) {
                    this.updateAudioStatus('🔄 Initializing Audio...', false);
                    
                    // Test speech synthesis with multiple approaches
                    this.testSpeechSynthesis();
                }
            },

            // Comprehensive speech synthesis test
            testSpeechSynthesis() {
                try {
                    // First, check if voices are available
                    const voices = speechSynthesis.getVoices();
                    console.log('Available voices:', voices.length);
                    
                    if (voices.length === 0) {
                        // Wait a bit more for voices to load
                        setTimeout(() => {
                            this.testSpeechSynthesis();
                        }, 500);
                        return;
                    }

                    // Create a test utterance with minimal settings
                    const testUtterance = new SpeechSynthesisUtterance('test');
                    testUtterance.volume = 0; // Silent test
                    testUtterance.rate = 1;
                    testUtterance.pitch = 1;
                    testUtterance.lang = 'en-US';
                    
                    // Try to find an English voice
                    const englishVoice = voices.find(voice => 
                        voice.lang.startsWith('en') && !voice.name.includes('Google')
                    ) || voices.find(voice => voice.lang.startsWith('en')) || voices[0];
                    
                    if (englishVoice) {
                        testUtterance.voice = englishVoice;
                        console.log('Using voice:', englishVoice.name, englishVoice.lang);
                    }

                    // Set up success handler
                    testUtterance.onstart = () => {
                        console.log('Speech synthesis test successful');
                        this.audioInitialized = true;
                        this.audioEnabled = true;
                        this.updateAudioStatus('🔊 Audio Ready!', false);
                        
                        // Auto-hide after success
                        setTimeout(() => {
                            const statusEl = document.getElementById('audioStatus');
                            if (statusEl) statusEl.style.opacity = '0.3';
                        }, 2000);
                    };

                    // Set up error handler
                    testUtterance.onerror = (event) => {
                        console.log('Speech synthesis test failed:', event.error);
                        this.handleAudioError(event.error);
                    };

                    // Set up end handler for silent test
                    testUtterance.onend = () => {
                        if (!this.audioInitialized) {
                            // If we got here without onstart firing, consider it working
                            console.log('Speech synthesis appears to work (onend fired)');
                            this.audioInitialized = true;
                            this.audioEnabled = true;
                            this.updateAudioStatus('🔊 Audio Ready!', false);
                        }
                    };

                    // Try to speak
                    console.log('Attempting to speak test utterance...');
                    speechSynthesis.speak(testUtterance);
                    
                    // Fallback timeout
                    setTimeout(() => {
                        if (!this.audioInitialized) {
                            console.log('Speech test timeout - assuming it works');
                            this.audioInitialized = true;
                            this.audioEnabled = true;
                            this.updateAudioStatus('🔊 Audio Ready (Assumed)', false);
                        }
                    }, 2000);

                } catch (error) {
                    console.error('Error testing speech synthesis:', error);
                    this.handleAudioError(error.message);
                }
            },

            // Handle audio initialization errors
            handleAudioError(errorMessage) {
                console.log('Audio error:', errorMessage);
                
                const errorMap = {
                    'not-allowed': '🚫 Audio Permission Denied',
                    'not-supported': '❌ Audio Not Supported',
                    'network': '🌐 Network Error',
                    'synthesis-failed': '⚠️ Audio Engine Failed',
                    'synthesis-unavailable': '⚠️ Audio Service Unavailable'
                };
                
                const displayError = errorMap[errorMessage] || '⚠️ Audio Error';
                this.updateAudioStatus(displayError, true);
                
                // For mobile, provide additional guidance
                if (this.isMobile) {
                    setTimeout(() => {
                        this.updateAudioStatus('📱 Try Different Browser', true);
                    }, 3000);
                }
            },

            // Handle voices loaded
            onVoicesChanged() {
                const voices = speechSynthesis.getVoices();
                console.log('Voices changed event - found', voices.length, 'voices');
                
                if (voices.length > 0) {
                    // Log available voices for debugging
                    const englishVoices = voices.filter(voice => voice.lang.startsWith('en'));
                    console.log('English voices available:', englishVoices.map(v => `${v.name} (${v.lang})`));
                    
                    if (englishVoices.length > 0) {
                        this.audioEnabled = true;
                        console.log('Audio system ready with', englishVoices.length, 'English voices');
                        
                        if (this.audioInitialized) {
                            this.updateAudioStatus('🔊 Audio Ready', false);
                        }
                    } else {
                        console.log('No English voices found');
                        this.updateAudioStatus('⚠️ No English Voices', true);
                    }
                } else {
                    console.log('No voices found in onVoicesChanged');
                    this.updateAudioStatus('⚠️ No Voices Found', true);
                }
            },

            // Update audio status indicator with debug info
            updateAudioStatus(text, isError) {
                const statusEl = document.getElementById('audioStatus');
                if (statusEl) {
                    statusEl.textContent = text;
                    statusEl.className = 'audio-status' + (isError ? ' disabled' : '');
                    
                    // Always ensure the debug handler is attached
                    this.setupAudioDebugHandler();
                    
                    // Auto-hide success states
                    if (!isError && this.audioInitialized) {
                        setTimeout(() => {
                            statusEl.style.opacity = '0.3';
                        }, 3000);
                    } else {
                        statusEl.style.opacity = '1';
                    }
                }
                
                // Also log to console
                console.log('Audio Status:', text);
            },

            // Show detailed audio debug information - works even when audio not supported
            showAudioDebugInfo() {
                console.log('Showing audio debug info...');
                
                // Get basic info even if speech synthesis isn't supported
                const userAgent = navigator.userAgent;
                
                // Detect browser
                let browser = 'Unknown';
                if (userAgent.includes('Chrome') && !userAgent.includes('Edg')) browser = 'Chrome';
                else if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) browser = 'Safari';
                else if (userAgent.includes('Firefox')) browser = 'Firefox';
                else if (userAgent.includes('Edg')) browser = 'Edge';
                
                let info = [
                    `🔧 AUDIO DEBUG INFO`,
                    ``,
                    `📱 Device & Browser:`,
                    `• Browser: ${browser}`,
                    `• Mobile: ${this.isMobile ? 'Yes' : 'No'}`,
                    `• HTTPS: ${location.protocol === 'https:' ? 'Yes' : 'No'}`,
                    `• URL: ${location.hostname}`,
                    `• User Agent: ${userAgent.substring(0, 50)}...`,
                    ``,
                    `🔊 Audio System:`,
                    `• Native Speech API: ${this.speechAvailable ? 'Yes' : 'No'}`,
                    `• ResponsiveVoice: ${this.responsiveVoiceAvailable ? 'Yes' : 'No'}`,
                    `• Current Method: ${this.currentAudioMethod || 'None'}`,
                    `• Audio Initialized: ${this.audioInitialized ? 'Yes' : 'No'}`,
                    `• Audio Enabled: ${this.audioEnabled ? 'Yes' : 'No'}`
                ];

                // Add speech synthesis specific info if available
                if (this.speechAvailable) {
                    try {
                        const voices = speechSynthesis.getVoices();
                        const englishVoices = voices.filter(v => v.lang.startsWith('en'));
                        
                        info.push(
                            ``,
                            `🎤 Voice System:`,
                            `• Total Voices: ${voices.length}`,
                            `• English Voices: ${englishVoices.length}`,
                            `• Currently Speaking: ${speechSynthesis.speaking ? 'Yes' : 'No'}`,
                            `• Speech Pending: ${speechSynthesis.pending ? 'Yes' : 'No'}`,
                            `• Speech Paused: ${speechSynthesis.paused ? 'Yes' : 'No'}`
                        );
                        
                        if (englishVoices.length > 0) {
                            info.push(``, `🇺🇸 Available English Voices:`);
                            englishVoices.slice(0, 5).forEach(voice => {
                                info.push(`• ${voice.name} (${voice.lang})`);
                            });
                            if (englishVoices.length > 5) {
                                info.push(`• ... and ${englishVoices.length - 5} more`);
                            }
                        }
                    } catch (error) {
                        info.push(``, `❌ Error accessing voice system: ${error.message}`);
                    }
                } else {
                    info.push(
                        ``,
                        `❌ Speech Synthesis Check:`,
                        `• 'speechSynthesis' in window: ${'speechSynthesis' in window}`,
                        `• 'SpeechSynthesisUtterance' in window: ${'SpeechSynthesisUtterance' in window}`
                    );
                    
                    if ('speechSynthesis' in window) {
                        info.push(`• speechSynthesis.speak exists: ${typeof speechSynthesis.speak === 'function'}`);
                        info.push(`• speechSynthesis.getVoices exists: ${typeof speechSynthesis.getVoices === 'function'}`);
                    }
                }
                
                // Add troubleshooting tips
                info.push(``, `🛠️ TROUBLESHOOTING:`);
                
                if (!this.speechAvailable && !this.responsiveVoiceAvailable) {
                    info.push(`❌ No audio methods available`);
                    info.push(`💡 Solutions:`);
                    if (browser === 'Unknown' || browser.includes('WebView')) {
                        info.push(`  • Try opening in a proper browser (Chrome/Safari/Firefox)`);
                        info.push(`  • Don't use in-app browsers (Instagram, Facebook, etc.)`);
                    } else {
                        info.push(`  • Try Chrome (best speech support)`);
                        info.push(`  • Try Safari on iOS/Mac`);
                        info.push(`  • Try Firefox as alternative`);
                        info.push(`  • Update your browser to latest version`);
                        info.push(`  • Check internet connection (for ResponsiveVoice)`);
                    }
                } else if (this.responsiveVoiceAvailable) {
                    info.push(`✅ ResponsiveVoice available - should work on mobile!`);
                    if (!this.audioInitialized) {
                        info.push(`💡 Try: Tapping anywhere to initialize audio`);
                    } else {
                        info.push(`💡 If not working:`);
                        info.push(`  • Check device volume and mute settings`);
                        info.push(`  • Check internet connection`);
                        info.push(`  • Try tapping a 🔊 Play button`);
                    }
                } else if (this.speechAvailable) {
                    try {
                        const voices = speechSynthesis.getVoices();
                        const englishVoices = voices.filter(v => v.lang.startsWith('en'));
                        
                        if (voices.length === 0) {
                            info.push(`❌ No voices available`);
                            info.push(`💡 Solutions:`);
                            info.push(`  • Refresh the page and wait a moment`);
                            info.push(`  • Check internet connection`);
                            info.push(`  • Try different browser`);
                        } else if (englishVoices.length === 0) {
                            info.push(`❌ No English voices found`);
                            info.push(`💡 Solutions:`);
                            info.push(`  • Install English language pack`);
                            info.push(`  • Check system language settings`);
                        } else if (!this.audioInitialized) {
                            info.push(`❌ Audio not initialized`);
                            info.push(`💡 Solutions:`);
                            info.push(`  • Tap anywhere on screen to enable`);
                            info.push(`  • Check browser audio permissions`);
                        } else {
                            info.push(`✅ Native speech synthesis working!`);
                        }
                    } catch (error) {
                        info.push(`❌ Error checking voice system: ${error.message}`);
                    }
                }
                
                if (this.isMobile) {
                    info.push(``, `📱 Mobile-Specific Tips:`);
                    info.push(`• Make sure volume is up`);
                    info.push(`• Turn off silent/vibrate mode`);
                    info.push(`• Close other apps using audio`);
                    info.push(`• Try Chrome or Safari browser`);
                    info.push(`• Don't use in-app browsers`);
                    info.push(`• ResponsiveVoice fallback should work on most devices`);
                    if (location.protocol !== 'https:') {
                        info.push(`• HTTPS may be required for mobile audio`);
                    }
                }
                
                // Show the debug info in an alert
                try {
                    alert(info.join('\n'));
                } catch (error) {
                    // Fallback if alert fails
                    console.log('Debug Info:', info.join('\n'));
                    
                    // Try to show in a different way
                    const debugText = info.join('\n');
                    if (confirm('Audio Debug Info (click OK to copy to clipboard):\n\n' + debugText.substring(0, 500) + '...')) {
                        // Try to copy to clipboard
                        if (navigator.clipboard) {
                            navigator.clipboard.writeText(debugText).catch(() => {
                                console.log('Could not copy to clipboard');
                            });
                        }
                    }
                }
                
                // Also log comprehensive info to console for developers
                console.log('Audio Debug Info:', {
                    browser,
                    isMobile: this.isMobile,
                    speechAvailable: this.speechAvailable,
                    audioInitialized: this.audioInitialized,
                    audioEnabled: this.audioEnabled,
                    speechSynthesisExists: 'speechSynthesis' in window,
                    speechSynthesisUtteranceExists: 'SpeechSynthesisUtterance' in window,
                    userAgent: userAgent
                });
            },

            // Enhanced speak function with multiple audio methods
            speak(text) {
                // Clean the text
                const cleanText = text.replace(/\*\*/g, '').replace(/<[^>]*>/g, '').trim();
                
                if (!cleanText) {
                    console.log('No text to speak');
                    return;
                }

                if (!this.audioEnabled) {
                    console.log('Audio not enabled - try clicking the status indicator');
                    this.updateAudioStatus('🔊 Click to Enable Audio', true);
                    return;
                }

                console.log(`Speaking with ${this.currentAudioMethod}:`, cleanText);

                // Use the appropriate speech method
                if (this.currentAudioMethod === 'responsivevoice') {
                    this.speakWithResponsiveVoice(cleanText);
                } else if (this.currentAudioMethod === 'native') {
                    this.speakWithNative(cleanText);
                } else {
                    // Try to auto-detect and use any available method
                    if (this.responsiveVoiceAvailable) {
                        this.currentAudioMethod = 'responsivevoice';
                        this.speakWithResponsiveVoice(cleanText);
                    } else if (this.speechAvailable) {
                        this.currentAudioMethod = 'native';
                        this.speakWithNative(cleanText);
                    } else {
                        console.log('No audio method available');
                        this.updateAudioStatus('❌ No Audio Available', true);
                    }
                }
            },

            // Speak using ResponsiveVoice
            speakWithResponsiveVoice(text) {
                try {
                    if (typeof responsiveVoice === 'undefined' || !responsiveVoice) {
                        console.log('ResponsiveVoice not available');
                        this.fallbackToNative(text);
                        return;
                    }

                    // Cancel any ongoing speech
                    if (responsiveVoice.isPlaying()) {
                        responsiveVoice.cancel();
                    }

                    this.updateAudioStatus('🔊 Speaking...', false);

                    // Use ResponsiveVoice to speak
                    responsiveVoice.speak(text, "US English Female", {
                        rate: this.isMobile ? 0.7 : 0.8,
                        pitch: 1,
                        volume: 1,
                        onstart: () => {
                            console.log('ResponsiveVoice speech started');
                            this.updateAudioStatus('🔊 Speaking (RV)...', false);
                        },
                        onend: () => {
                            console.log('ResponsiveVoice speech ended');
                            this.updateAudioStatus('🔊 Audio Ready (RV)', false);
                        },
                        onerror: (error) => {
                            console.log('ResponsiveVoice error:', error);
                            this.handleSpeechError('responsivevoice-error');
                            // Try native as fallback
                            this.fallbackToNative(text);
                        }
                    });

                } catch (error) {
                    console.error('Error with ResponsiveVoice:', error);
                    this.fallbackToNative(text);
                }
            },

            // Speak using native speech synthesis
            speakWithNative(text) {
                if (!this.speechAvailable) {
                    console.log('Native speech synthesis not available');
                    this.fallbackToResponsiveVoice(text);
                    return;
                }

                // Cancel any ongoing speech
                try {
                    if (speechSynthesis.speaking || speechSynthesis.pending) {
                        speechSynthesis.cancel();
                        console.log('Cancelled previous speech');
                    }
                } catch (error) {
                    console.log('Error canceling previous speech:', error);
                }

                // Wait for cancel to complete
                const speakDelay = this.isMobile ? 150 : 50;
                setTimeout(() => {
                    this.speakText(text);
                }, speakDelay);
            },

            // Fallback from ResponsiveVoice to native
            fallbackToNative(text) {
                if (this.speechAvailable) {
                    console.log('Falling back to native speech synthesis');
                    this.currentAudioMethod = 'native';
                    this.speakWithNative(text);
                } else {
                    console.log('No fallback audio method available');
                    this.updateAudioStatus('❌ Speech Failed', true);
                }
            },

            // Fallback from native to ResponsiveVoice
            fallbackToResponsiveVoice(text) {
                if (this.responsiveVoiceAvailable) {
                    console.log('Falling back to ResponsiveVoice');
                    this.currentAudioMethod = 'responsivevoice';
                    this.speakWithResponsiveVoice(text);
                } else {
                    console.log('No fallback audio method available');
                    this.updateAudioStatus('❌ Speech Failed', true);
                }
            },

            // Actually speak the text with comprehensive error handling
            speakText(text) {
                try {
                    const utterance = new SpeechSynthesisUtterance(text);
                    
                    // Configure utterance with mobile optimizations
                    utterance.lang = 'en-US';
                    utterance.rate = this.isMobile ? 0.7 : 0.8; // Even slower on mobile
                    utterance.pitch = 1;
                    utterance.volume = 1;

                    // Try to use the best available English voice
                    const voices = speechSynthesis.getVoices();
                    let selectedVoice = null;
                    
                    // Preference order: US English -> any English -> first available
                    selectedVoice = voices.find(voice => voice.lang === 'en-US') ||
                                  voices.find(voice => voice.lang === 'en-GB') ||
                                  voices.find(voice => voice.lang.startsWith('en')) ||
                                  voices[0];
                    
                    if (selectedVoice) {
                        utterance.voice = selectedVoice;
                        console.log('Using voice:', selectedVoice.name, selectedVoice.lang);
                    } else {
                        console.log('No voice selected, using default');
                    }

                    // Set up event handlers
                    utterance.onstart = () => {
                        console.log('Speech started successfully');
                        this.updateAudioStatus('🔊 Speaking...', false);
                    };

                    utterance.onend = () => {
                        console.log('Speech ended');
                        this.updateAudioStatus('🔊 Audio Ready', false);
                    };

                    utterance.onerror = (event) => {
                        console.log('Speech error:', event.error, event);
                        this.handleSpeechError(event.error);
                    };

                    // Additional mobile-specific handling
                    if (this.isMobile) {
                        // Some mobile browsers need extra nudging
                        const startTime = Date.now();
                        
                        utterance.onstart = (event) => {
                            console.log('Mobile speech started after', Date.now() - startTime, 'ms');
                            this.updateAudioStatus('🔊 Speaking...', false);
                        };
                        
                        // Timeout fallback for mobile
                        setTimeout(() => {
                            if (!speechSynthesis.speaking && speechSynthesis.pending) {
                                console.log('Mobile speech timeout - retrying');
                                speechSynthesis.cancel();
                                setTimeout(() => {
                                    speechSynthesis.speak(utterance);
                                }, 100);
                            }
                        }, 1000);
                    }

                    // Speak the utterance
                    console.log('Calling speechSynthesis.speak()');
                    speechSynthesis.speak(utterance);

                } catch (error) {
                    console.error('Error creating or speaking utterance:', error);
                    this.handleSpeechError(error.message || 'unknown');
                }
            },

            // Handle speech-specific errors
            handleSpeechError(errorType) {
                const errorMessages = {
                    'not-allowed': '🚫 Audio Blocked - Check Settings',
                    'interrupted': '⏸️ Audio Interrupted',
                    'audio-busy': '⏳ Audio Busy - Try Again',
                    'audio-hardware': '🔇 Audio Hardware Issue',
                    'synthesis-failed': '⚠️ Speech Failed',
                    'synthesis-unavailable': '⚠️ Speech Service Down',
                    'network': '🌐 Network Required',
                    'text-too-long': '📝 Text Too Long',
                    'rate-not-supported': '⚠️ Rate Not Supported',
                    'pitch-not-supported': '⚠️ Pitch Not Supported',
                    'volume-not-supported': '⚠️ Volume Not Supported',
                    'voice-not-supported': '⚠️ Voice Not Supported'
                };
                
                const message = errorMessages[errorType] || `⚠️ Speech Error: ${errorType}`;
                this.updateAudioStatus(message, true);
                
                // Reset after error
                setTimeout(() => {
                    if (this.audioEnabled) {
                        this.updateAudioStatus('🔊 Audio Ready', false);
                    }
                }, 3000);
            },
            
            // Article Exercise Functions
            startArticleExercise() {
                // Initialize available indices for no-repeat system
                this.availableArticleIndices = Array.from({length: data.articleTaskSentences.length}, (_, i) => i);
                this.currentArticleIndex = this.getNextArticleIndex();
                this.articleAnswerRevealed = false;
                this.articleInstructionsCollapsed = false;
                
                // Reset instructions
                const instructions = document.getElementById('articleInstructions');
                if (instructions) {
                    instructions.innerHTML = `Решите, нужен ли артикль "a", "an"<br>
                    Клик на примере для просмотра ответа<br>
                    Клик на инструкции, чтобы её скрыть<br>
                    Next - новый пример`;
                }
                
                this.navigationHistory.push('articleExercise');
                this.showScreen('articleExercise');
                this.updateArticleDisplay();
            },
            
            getNextArticleIndex() {
                // If no more available indices, reset the array
                if (this.availableArticleIndices.length === 0) {
                    this.availableArticleIndices = Array.from({length: data.articleTaskSentences.length}, (_, i) => i);
                }
                
                // Pick a random index from available ones
                const randomPosition = Math.floor(Math.random() * this.availableArticleIndices.length);
                const selectedIndex = this.availableArticleIndices[randomPosition];
                
                // Remove the selected index from available ones
                this.availableArticleIndices.splice(randomPosition, 1);
                
                return selectedIndex;
            },
            
            updateArticleDisplay() {
                const taskSentence = data.articleTaskSentences[this.currentArticleIndex];
                const answerSentence = data.articleAnswerSentences[this.currentArticleIndex];
                
                document.getElementById('articleTask').textContent = taskSentence;
                document.getElementById('articleAnswer').innerHTML = answerSentence;
                
                // Reset state
                this.articleAnswerRevealed = false;
                document.getElementById('articleTask').style.display = 'block';
                document.getElementById('articleAnswer').style.display = 'none';
                document.getElementById('articleAnswer').classList.add('hidden');
                document.getElementById('articleContainer').classList.remove('answered');
            },
            
            revealArticleAnswer() {
                if (!this.articleAnswerRevealed) {
                    this.articleAnswerRevealed = true;
                    document.getElementById('articleTask').style.display = 'none';
                    document.getElementById('articleAnswer').style.display = 'block';
                    document.getElementById('articleAnswer').classList.remove('hidden');
                    document.getElementById('articleContainer').classList.add('answered');
                }
            },
            
            nextArticleExample() {
                this.currentArticleIndex = this.getNextArticleIndex();
                this.updateArticleDisplay();
            },
            
            playArticleAudio() {
                const currentSentence = this.articleAnswerRevealed ? 
                    document.getElementById('articleAnswer').textContent : 
                    document.getElementById('articleTask').textContent;
                
                this.speak(currentSentence);
            },
            
            showArticleRules() {
                const modalOverlay = document.createElement('div');
                modalOverlay.className = 'modal-overlay';
                modalOverlay.id = 'articleRulesModal';
                modalOverlay.onclick = (e) => {
                    if (e.target === modalOverlay) {
                        this.closeArticleRules();
                    }
                };
                
                const modalContent = document.createElement('div');
                modalContent.className = 'modal-content';
                
                const closeButton = document.createElement('button');
                closeButton.className = 'modal-close';
                closeButton.innerHTML = '×';
                closeButton.onclick = () => this.closeArticleRules();
                
                const title = document.createElement('h3');
                title.className = 'modal-title';
                title.textContent = 'Articles A/An Rules';
                
                const description = document.createElement('div');
                description.className = 'modal-description';
                description.id = 'articleRulesDescription';
                description.textContent = data.articleRules[this.currentRulesLanguage];
                description.onclick = () => this.toggleArticleRulesLanguage();
                
                modalContent.appendChild(closeButton);
                modalContent.appendChild(title);
                modalContent.appendChild(description);
                modalOverlay.appendChild(modalContent);
                
                document.body.appendChild(modalOverlay);
                this.currentRulesLanguage = 'russian';
            },
            
            closeArticleRules() {
                const modal = document.getElementById('articleRulesModal');
                if (modal) modal.remove();
            },
            
            toggleArticleRulesLanguage() {
                this.currentRulesLanguage = 
                    this.currentRulesLanguage === 'russian' ? 'english' : 'russian';
                const description = document.getElementById('articleRulesDescription');
                if (description) {
                    description.textContent = data.articleRules[this.currentRulesLanguage];
                }
            },
            
            toggleArticleInstructions() {
                const instructions = document.getElementById('articleInstructions');
                if (instructions) {
                    this.articleInstructionsCollapsed = !this.articleInstructionsCollapsed;
                    if (this.articleInstructionsCollapsed) {
                        instructions.innerHTML = 'Instructions ▼';
                    } else {
                        instructions.innerHTML = `Решите, нужен ли артикль "a", "an"<br>
                        Клик на примере для просмотра ответа<br>
                        Клик на инструкции, чтобы её скрыть<br>
                        Next - новый пример`;
                    }
                }
            },
            
            // A vs The Exercise Functions
            startAvsTheExercise() {
                // Initialize available indices for no-repeat system
                this.availableAvsTheIndices = Array.from({length: data.avstheExamples.length}, (_, i) => i);
                this.currentAvsTheIndex = this.getNextAvsTheIndex();
                this.avstheAnswerRevealed = false;
                this.avstheInstructionsCollapsed = false;
                
                // Reset instructions
                const instructions = document.getElementById('avstheInstructions');
                if (instructions) {
                    instructions.innerHTML = `Сравните использование "a" и "the"<br>
                    Клик на примере для просмотра второго предложения<br>
                    Клик на инструкции, чтобы её скрыть<br>
                    Next - новый пример`;
                }
                
                this.navigationHistory.push('avstheExercise');
                this.showScreen('avstheExercise');
                this.updateAvsTheDisplay();
            },
            
            getNextAvsTheIndex() {
                // If no more available indices, reset the array
                if (this.availableAvsTheIndices.length === 0) {
                    this.availableAvsTheIndices = Array.from({length: data.avstheExamples.length}, (_, i) => i);
                }
                
                // Pick a random index from available ones
                const randomPosition = Math.floor(Math.random() * this.availableAvsTheIndices.length);
                const selectedIndex = this.availableAvsTheIndices[randomPosition];
                
                // Remove the selected index from available ones
                this.availableAvsTheIndices.splice(randomPosition, 1);
                
                return selectedIndex;
            },
            
            updateAvsTheDisplay() {
                const example = data.avstheExamples[this.currentAvsTheIndex];
                
                document.getElementById('aExample').innerHTML = example.aExample;
                document.getElementById('theExample').innerHTML = example.theExample;
                
                // Reset state
                this.avstheAnswerRevealed = false;
                document.getElementById('aExample').style.display = 'block';
                document.getElementById('theExample').style.display = 'none';
                document.getElementById('theExample').classList.add('hidden');
                document.getElementById('avstheContainer').classList.remove('answered');
            },
            
            revealTheExample() {
                if (!this.avstheAnswerRevealed) {
                    this.avstheAnswerRevealed = true;
                    document.getElementById('aExample').style.display = 'none';
                    document.getElementById('theExample').style.display = 'block';
                    document.getElementById('theExample').classList.remove('hidden');
                    document.getElementById('avstheContainer').classList.add('answered');
                }
            },
            
            nextAvsTheExample() {
                this.currentAvsTheIndex = this.getNextAvsTheIndex();
                this.updateAvsTheDisplay();
            },
            
            playAvsTheAudio() {
                const currentSentence = this.avstheAnswerRevealed ? 
                    document.getElementById('theExample').textContent : 
                    document.getElementById('aExample').textContent;
                
                this.speak(currentSentence);
            },
            
            showAvsTheRules() {
                const modalOverlay = document.createElement('div');
                modalOverlay.className = 'modal-overlay';
                modalOverlay.id = 'avstheRulesModal';
                modalOverlay.onclick = (e) => {
                    if (e.target === modalOverlay) {
                        this.closeAvsTheRules();
                    }
                };
                
                const modalContent = document.createElement('div');
                modalContent.className = 'modal-content';
                
                const closeButton = document.createElement('button');
                closeButton.className = 'modal-close';
                closeButton.innerHTML = '×';
                closeButton.onclick = () => this.closeAvsTheRules();
                
                const title = document.createElement('h3');
                title.className = 'modal-title';
                title.textContent = 'A vs The Rules';
                
                const description = document.createElement('div');
                description.className = 'modal-description';
                description.id = 'avstheRulesDescription';
                description.textContent = data.avstheRules[this.currentRulesLanguage];
                description.onclick = () => this.toggleAvsTheRulesLanguage();
                
                modalContent.appendChild(closeButton);
                modalContent.appendChild(title);
                modalContent.appendChild(description);
                modalOverlay.appendChild(modalContent);
                
                document.body.appendChild(modalOverlay);
                this.currentRulesLanguage = 'russian';
            },
            
            closeAvsTheRules() {
                const modal = document.getElementById('avstheRulesModal');
                if (modal) modal.remove();
            },
            
            toggleAvsTheRulesLanguage() {
                this.currentRulesLanguage = 
                    this.currentRulesLanguage === 'russian' ? 'english' : 'russian';
                const description = document.getElementById('avstheRulesDescription');
                if (description) {
                    description.textContent = data.avstheRules[this.currentRulesLanguage];
                }
            },
            
            toggleAvsTheInstructions() {
                const instructions = document.getElementById('avstheInstructions');
                if (instructions) {
                    this.avstheInstructionsCollapsed = !this.avstheInstructionsCollapsed;
                    if (this.avstheInstructionsCollapsed) {
                        instructions.innerHTML = 'Instructions ▼';
                    } else {
                        instructions.innerHTML = `Сравните использование "a" и "the"<br>
                        Клик на примере для просмотра второго предложения<br>
                        Клик на инструкции, чтобы её скрыть<br>
                        Next - новый пример`;
                    }
                }
            },
            
            // Toggle examples visibility
            toggleExamples() {
                this.examplesHidden = !this.examplesHidden;
                const sentences = ['sentence2', 'sentence3', 'sentence4'];
                
                sentences.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        if (this.examplesHidden) {
                            element.style.display = 'none';
                        } else {
                            element.style.display = 'block';
                        }
                    }
                });
            },
            
            // Apply hidden state
            applyExamplesVisibility() {
                if (this.examplesHidden) {
                    const sentences = ['sentence2', 'sentence3', 'sentence4'];
                    sentences.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'none';
                        }
                    });
                }
            },
            
            // Screen management
            showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.add('hidden');
                });
                document.getElementById(screenId).classList.remove('hidden');
            },
            
            showMainMenu() {
                this.navigationHistory = ['mainMenu'];
                this.showScreen('mainMenu');
            },
            
            showExercises() {
                this.navigationHistory.push('exercisesMenu');
                this.showScreen('exercisesMenu');
            },
            
            showSimpleMenu() {
                this.navigationHistory.push('simpleMenu');
                this.showScreen('simpleMenu');
            },
            
            showContinuousMenu() {
                this.navigationHistory.push('continuousMenu');
                this.showScreen('continuousMenu');
            },
            
            showTestYourself() {
                this.navigationHistory.push('testYourself');
                this.showScreen('testYourself');
                this.instructionsCollapsed = false;
                const instructions = document.getElementById('testInstructions');
                if (instructions) {
                    instructions.innerHTML = `Составь в заданном времени:<br>
                    - Утверждение<br>
                    - Отрицание<br>
                    - Вопрос<br>
                    - Wh-вопрос<br>
                    Клик, чтобы проверить себя`;
                }
                this.generateNewTest();
            },
            
            goBack() {
                if (this.navigationHistory.length > 1) {
                    this.navigationHistory.pop();
                    const previousScreen = this.navigationHistory[this.navigationHistory.length - 1];
                    this.showScreen(previousScreen);
                }
            },
            
            // Exercise management
            startExercise(tense) {
                this.currentTense = tense;
                this.currentSubjectIndex = 0;
                this.currentVerb = 'go';
                this.exerciseInstructionsCollapsed = false;
                
                // Reset examples visibility to shown
                this.examplesHidden = false;
                const sentences = ['sentence2', 'sentence3', 'sentence4'];
                sentences.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.style.display = 'block';
                    }
                });
                
                // Reset instructions to expanded
                const instructions = document.getElementById('exerciseSubtitle');
                if (instructions) {
                    instructions.innerHTML = `Next - поменять подлежащее<br>
                    Change the Word - поменять глагол<br>
                    Клик на примерах, чтобы скрыть всё, кроме утверждения`;
                }
                
                // Update title and back button
                const titles = {
                    'present': 'Present Simple',
                    'past': 'Past Simple', 
                    'future': 'Future Simple',
                    'presentPerfect': 'Present Perfect',
                    'pastPerfect': 'Past Perfect',
                    'presentContinuous': 'Present Continuous',
                    'pastContinuous': 'Past Continuous',
                    'futureContinuous': 'Future Continuous',
                    'presentPerfectContinuous': 'Present Perfect Continuous',
                    'pastPerfectContinuous': 'Past Perfect Continuous'
                };
                
                document.getElementById('exerciseTitle').textContent = titles[tense];
                
                // Set appropriate back navigation
                const backButton = document.getElementById('exerciseBackButton');
                if (['present', 'past', 'future', 'presentPerfect', 'pastPerfect'].includes(tense)) {
                    backButton.onclick = () => this.showSimpleMenu();
                } else {
                    backButton.onclick = () => this.showContinuousMenu();
                }
                
                this.navigationHistory.push('exerciseTemplate');
                this.showScreen('exerciseTemplate');
                this.updateExerciseDisplay();
            },
            
            updateExerciseDisplay() {
                if (this.isLoading) return;
                
                const subject = data.allSubjects[this.currentSubjectIndex];
                const verbData = data.getVerbData(this.currentVerb, this.currentTense, subject);
                
                if (verbData) {
                    document.getElementById('sentence1').textContent = verbData.positive;
                    document.getElementById('sentence2').textContent = verbData.negative;
                    document.getElementById('sentence3').textContent = verbData.question;
                    document.getElementById('sentence4').textContent = verbData.whQuestion;
                }
                
                // Update verb info
                const russianInfinitive = data.verbInfinitives[this.currentVerb] || '';
                const threeFormsDisplay = data.verbForms[this.currentVerb] ? 
                    `<br>(${data.verbForms[this.currentVerb]})` : '';
                document.getElementById('currentVerbInfo').innerHTML = 
                    `Current verb: ${this.currentVerb} - ${russianInfinitive}${threeFormsDisplay}`;
                
                // Apply hidden state
                this.applyExamplesVisibility();
            },
            
            nextSubject() {
                if (!this.isLoading) {
                    this.currentSubjectIndex++;
                    if (this.currentSubjectIndex >= data.allSubjects.length) {
                        this.currentSubjectIndex = 0;
                    }
                    this.updateExerciseDisplay();
                }
            },
            
            previousSubject() {
                if (!this.isLoading) {
                    this.currentSubjectIndex--;
                    if (this.currentSubjectIndex < 0) {
                        this.currentSubjectIndex = data.allSubjects.length - 1;
                    }
                    this.updateExerciseDisplay();
                }
            },
            
            changeVerb() {
                if (this.isLoading) return;
                
                const verbs = Object.keys(data.verbInfinitives);
                let newVerb;
                let attempts = 0;
                
                do {
                    newVerb = verbs[Math.floor(Math.random() * verbs.length)];
                    attempts++;
                    if (attempts > 10 && newVerb === this.currentVerb) {
                        newVerb = 'play';
                    }
                } while (newVerb === this.currentVerb);
                
                this.currentVerb = newVerb;
                this.currentSubjectIndex = Math.floor(Math.random() * data.allSubjects.length);
                this.updateExerciseDisplay();
            },
            
            // Enhanced playAudio function
            playAudio() {
                const sentences = [
                    document.getElementById('sentence1').textContent,
                    document.getElementById('sentence2').textContent,
                    document.getElementById('sentence3').textContent,
                    document.getElementById('sentence4').textContent
                ];
                
                let index = 0;
                const speakNext = () => {
                    if (index < sentences.length) {
                        this.speak(sentences[index]);
                        index++;
                        setTimeout(speakNext, this.isMobile ? 3000 : 2500); // Longer pause on mobile
                    }
                };
                speakNext();
            },
            
            // Rules modal
            showRules() {
                const modalOverlay = document.createElement('div');
                modalOverlay.className = 'modal-overlay';
                modalOverlay.id = 'rulesModal';
                modalOverlay.onclick = (e) => {
                    if (e.target === modalOverlay) {
                        this.closeRules();
                    }
                };
                
                const modalContent = document.createElement('div');
                modalContent.className = 'modal-content';
                
                const closeButton = document.createElement('button');
                closeButton.className = 'modal-close';
                closeButton.innerHTML = '×';
                closeButton.onclick = () => this.closeRules();
                
                const title = document.createElement('h3');
                title.className = 'modal-title';
                
                const tenseConfig = data.tenseConfig[this.currentTense];
                title.textContent = tenseConfig.name + ' Rules';
                
                const description = document.createElement('div');
                description.className = 'modal-description';
                description.id = 'rulesDescription';
                description.textContent = data.tenseRules[this.currentTense][this.currentRulesLanguage];
                description.onclick = () => this.toggleRulesLanguage();
                
                modalContent.appendChild(closeButton);
                modalContent.appendChild(title);
                modalContent.appendChild(description);
                modalOverlay.appendChild(modalContent);
                
                document.body.appendChild(modalOverlay);
                this.currentRulesLanguage = 'russian';
            },
            
            closeRules() {
                const modal = document.getElementById('rulesModal');
                if (modal) modal.remove();
            },
            
            toggleRulesLanguage() {
                this.currentRulesLanguage = 
                    this.currentRulesLanguage === 'russian' ? 'english' : 'russian';
                const description = document.getElementById('rulesDescription');
                if (description) {
                    description.textContent = 
                        data.tenseRules[this.currentTense][this.currentRulesLanguage];
                }
            },
            
            // Test Yourself functions
            generateNewTest() {
                this.revealStage = 0;
                
                document.getElementById('testContainer').classList.remove('complete');
                document.getElementById('russianSentence').style.display = 'block';
                document.getElementById('russianSentence').classList.remove('hidden');
                document.querySelectorAll('.english').forEach(el => {
                    el.classList.add('hidden');
                    el.style.display = 'none';
                });
                
                let verbData = null;
                let randomSubject, randomVerb, randomTense;
                
                // Keep trying until we get a valid combination
                let attempts = 0;
                while (!verbData && attempts < 50) {
                    randomSubject = data.allSubjects[Math.floor(Math.random() * data.allSubjects.length)];
                    const verbs = Object.keys(data.verbInfinitives);
                    randomVerb = verbs[Math.floor(Math.random() * verbs.length)];
                    const tenses = Object.keys(data.tenseConfig);
                    randomTense = tenses[Math.floor(Math.random() * tenses.length)];
                    
                    verbData = data.getVerbData(randomVerb, randomTense, randomSubject);
                    attempts++;
                }
                
                if (verbData) {
                    const russianEl = document.getElementById('russianSentence');
                    const tenseConfig = data.tenseConfig[randomTense];
                    
                    // Display subject + (infinitive verb) instead of Russian
                    russianEl.innerHTML = `
                        <span class="tense-badge ${tenseConfig.class}" 
                              aria-label="Use ${tenseConfig.name} tense">
                            ⏱ ${tenseConfig.name}
                        </span>
                        ${randomSubject} (${randomVerb})
                    `;
                    
                    document.getElementById('englishPositive').textContent = verbData.positive;
                    document.getElementById('englishNegative').textContent = verbData.negative;
                    document.getElementById('englishQuestion').textContent = verbData.question;
                    document.getElementById('englishWhQuestion').textContent = verbData.whQuestion;
                    
                    this.currentTestData = {
                        sentences: [
                            verbData.positive,
                            verbData.negative,
                            verbData.question,
                            verbData.whQuestion
                        ]
                    };
                }
            },
            
            revealNext() {
                const elements = [
                    'englishPositive',
                    'englishNegative', 
                    'englishQuestion',
                    'englishWhQuestion'
                ];
                
                if (this.revealStage < elements.length) {
                    const element = document.getElementById(elements[this.revealStage]);
                    element.classList.remove('hidden');
                    element.style.cssText = 
                        'display: block !important; visibility: visible !important; opacity: 1 !important;';
                    this.revealStage++;
                    
                    if (this.revealStage === elements.length) {
                        document.getElementById('testContainer').classList.add('complete');
                    }
                }
            },
            
            toggleInstructions() {
                const instructions = document.getElementById('testInstructions');
                if (instructions) {
                    this.instructionsCollapsed = !this.instructionsCollapsed;
                    if (this.instructionsCollapsed) {
                        instructions.innerHTML = 'Instructions ▼';
                    } else {
                        instructions.innerHTML = `Составь в заданном времени:<br>
                        - Утверждение<br>
                        - Отрицание<br>
                        - Вопрос<br>
                        - Wh-вопрос<br>
                        Клик, чтобы проверить себя`;
                    }
                }
            },
            
            // Toggle exercise instructions
            toggleExerciseInstructions() {
                const instructions = document.getElementById('exerciseSubtitle');
                if (instructions) {
                    this.exerciseInstructionsCollapsed = !this.exerciseInstructionsCollapsed;
                    if (this.exerciseInstructionsCollapsed) {
                        instructions.innerHTML = 'Instructions ▼';
                    } else {
                        instructions.innerHTML = `Next - поменять подлежащее<br>
                        Change the Word - поменять глагол<br>
                        Клик на примерах, чтобы скрыть всё, кроме утверждения`;
                    }
                }
            }
        };

        // Data Module (keeping exactly the same as before)
        const data = {
            // A vs The exercise data
            avstheExamples: [
                {
                    aExample: "I bought <strong>a car</strong> yesterday.",
                    theExample: "<strong>The car</strong> is red and very fast."
                },
                {
                    aExample: "There's <strong>a cat</strong> in the garden.",
                    theExample: "<strong>The cat</strong> is sleeping under the tree."
                },
                {
                    aExample: "We need <strong>a teacher</strong> for this class.",
                    theExample: "<strong>The teacher</strong> should be experienced."
                },
                {
                    aExample: "I found <strong>a book</strong> on the floor.",
                    theExample: "<strong>The book</strong> belongs to Sarah."
                },
                {
                    aExample: "She ordered <strong>a pizza</strong> for dinner.",
                    theExample: "<strong>The pizza</strong> arrived in 30 minutes."
                },
                {
                    aExample: "He's looking for <strong>a job</strong>.",
                    theExample: "<strong>The job</strong> he wants is at Google."
                },
                {
                    aExample: "I heard <strong>a noise</strong> upstairs.",
                    theExample: "<strong>The noise</strong> was coming from the attic."
                },
                {
                    aExample: "They bought <strong>a house</strong> last month.",
                    theExample: "<strong>The house</strong> has a beautiful garden."
                },
                {
                    aExample: "I need <strong>a pen</strong> to write.",
                    theExample: "<strong>The pen</strong> on your desk is mine."
                },
                {
                    aExample: "She met <strong>a man</strong> at the conference.",
                    theExample: "<strong>The man</strong> was a famous scientist."
                },
                {
                    aExample: "We saw <strong>a movie</strong> last night.",
                    theExample: "<strong>The movie</strong> was really exciting."
                },
                {
                    aExample: "He's wearing <strong>a jacket</strong> today.",
                    theExample: "<strong>The jacket</strong> looks expensive."
                },
                {
                    aExample: "I need <strong>a computer</strong> for work.",
                    theExample: "<strong>The computer</strong> I want costs $2000."
                },
                {
                    aExample: "She's reading <strong>a newspaper</strong>.",
                    theExample: "<strong>The newspaper</strong> has interesting articles."
                },
                {
                    aExample: "We visited <strong>a museum</strong> yesterday.",
                    theExample: "<strong>The museum</strong> was closed on Mondays."
                },
                {
                    aExample: "He drives <strong>a truck</strong> for work.",
                    theExample: "<strong>The truck</strong> is very old but reliable."
                },
                {
                    aExample: "I saw <strong>a bird</strong> in the sky.",
                    theExample: "<strong>The bird</strong> was flying south."
                },
                {
                    aExample: "She found <strong>a wallet</strong> on the street.",
                    theExample: "<strong>The wallet</strong> contained $50."
                },
                {
                    aExample: "We need <strong>a solution</strong> to this problem.",
                    theExample: "<strong>The solution</strong> you suggested won't work."
                },
                {
                    aExample: "He's learning <strong>a language</strong>.",
                    theExample: "<strong>The language</strong> he's studying is Chinese."
                },
                {
                    aExample: "I bought <strong>a phone</strong> today.",
                    theExample: "<strong>The phone</strong> has an excellent camera."
                },
                {
                    aExample: "She's writing <strong>a letter</strong>.",
                    theExample: "<strong>The letter</strong> is for her grandmother."
                },
                {
                    aExample: "We're planning <strong>a trip</strong>.",
                    theExample: "<strong>The trip</strong> will be to Europe."
                },
                {
                    aExample: "He opened <strong>a restaurant</strong>.",
                    theExample: "<strong>The restaurant</strong> serves Italian food."
                },
                {
                    aExample: "I heard <strong>a song</strong> on the radio.",
                    theExample: "<strong>The song</strong> was by my favorite band."
                }
            ],
            
            // A vs The rules
            avstheRules: {
                english: "Use 'a/an' (indefinite article) when introducing something new, unknown, or any one of many. Use 'the' (definite article) when referring to something specific, already mentioned, known to both speaker and listener, or unique. For example: 'I bought a car' (any car, first mention) → 'The car is red' (that specific car we just mentioned).",
                russian: "Используйте 'a/an' (неопределенный артикль) при первом упоминании, когда говорите о чем-то новом, неизвестном или любом из многих. Используйте 'the' (определенный артикль) при ссылке на что-то конкретное, уже упомянутое, известное обеим сторонам или единственное в своем роде. Например: 'I bought a car' (любая машина, первое упоминание) → 'The car is red' (та конкретная машина, о которой мы только что говорили)."
            },
            
            // Article exercise data
            articleTaskSentences: [
                "I need (pen).",
                "She bought (apple).",
                "(Dogs) are loyal (animals).",
                "He is reading (book).",
                "(Water) is essential for (life).",
                "We saw (elephant) at the zoo.",
                "(Students) work hard.",
                "I want (sandwich) for lunch.",
                "(Music) helps me relax.",
                "She's (engineer).",
                "(Books) are expensive.",
                "There's (chair) in the corner.",
                "(Love) is important.",
                "He drives (truck).",
                "(Children) like (candy).",
                "I have (idea).",
                "(Coffee) tastes good.",
                "We need (umbrella).",
                "(Cars) need (fuel).",
                "She found (key) on the floor.",
                "It takes (hour) to drive there.",
                "(Teachers) help (students).",
                "He's (honest man).",
                "(Freedom) has (value).",
                "She attends (university).",
                "(Birds) can fly.",
                "I ate (orange) for breakfast.",
                "(Money) can't buy (happiness).",
                "He wore (uniform).",
                "(Flowers) smell nice.",
                "She's (doctor).",
                "(Information) was limited.",
                "We heard (interesting story).",
                "(Rice) is popular in (Asia).",
                "That's (useful tool).",
                "(Computers) are helpful.",
                "He's (architect).",
                "(Advice) is valuable.",
                "She wore (orange dress).",
                "(Tuesday) is my favorite (day).",
                "It's (European car).",
                "(Scientists) study (nature).",
                "I'm (teacher).",
                "(Knowledge) is (power).",
                "She has (unique style).",
                "(London) is beautiful.",
                "He's (accountant).",
                "(Happiness) comes from within.",
                "It's (one-way street).",
                "(Mozart) was (composer)."
            ],
            
            articleAnswerSentences: [
                "I need <strong>a pen</strong>.",
                "She bought <strong>an apple</strong>.",
                "<strong>Dogs</strong> are loyal <strong>animals</strong>.",
                "He is reading <strong>a book</strong>.",
                "<strong>Water</strong> is essential for <strong>life</strong>.",
                "We saw <strong>an elephant</strong> at the zoo.",
                "<strong>Students</strong> work hard.",
                "I want <strong>a sandwich</strong> for lunch.",
                "<strong>Music</strong> helps me relax.",
                "She's <strong>an engineer</strong>.",
                "<strong>Books</strong> are expensive.",
                "There's <strong>a chair</strong> in the corner.",
                "<strong>Love</strong> is important.",
                "He drives <strong>a truck</strong>.",
                "<strong>Children</strong> like <strong>candy</strong>.",
                "I have <strong>an idea</strong>.",
                "<strong>Coffee</strong> tastes good.",
                "We need <strong>an umbrella</strong>.",
                "<strong>Cars</strong> need <strong>fuel</strong>.",
                "She found <strong>a key</strong> on the floor.",
                "It takes <strong>an hour</strong> to drive there.",
                "<strong>Teachers</strong> help <strong>students</strong>.",
                "He's <strong>an honest man</strong>.",
                "<strong>Freedom</strong> has <strong>value</strong>.",
                "She attends <strong>a university</strong>.",
                "<strong>Birds</strong> can fly.",
                "I ate <strong>an orange</strong> for breakfast.",
                "<strong>Money</strong> can't buy <strong>happiness</strong>.",
                "He wore <strong>a uniform</strong>.",
                "<strong>Flowers</strong> smell nice.",
                "She's <strong>a doctor</strong>.",
                "<strong>Information</strong> was limited.",
                "We heard <strong>an interesting story</strong>.",
                "<strong>Rice</strong> is popular in <strong>Asia</strong>.",
                "That's <strong>a useful tool</strong>.",
                "<strong>Computers</strong> are helpful.",
                "He's <strong>an architect</strong>.",
                "<strong>Advice</strong> is valuable.",
                "She wore <strong>an orange dress</strong>.",
                "<strong>Tuesday</strong> is my favorite <strong>day</strong>.",
                "It's <strong>a European car</strong>.",
                "<strong>Scientists</strong> study <strong>nature</strong>.",
                "I'm <strong>a teacher</strong>.",
                "<strong>Knowledge</strong> is <strong>power</strong>.",
                "She has <strong>a unique style</strong>.",
                "<strong>London</strong> is beautiful.",
                "He's <strong>an accountant</strong>.",
                "<strong>Happiness</strong> comes from within.",
                "It's <strong>a one-way street</strong>.",
                "<strong>Mozart</strong> was <strong>a composer</strong>."
            ],
            
            // Article rules
            articleRules: {
                english: "Use 'a' before words that start with consonant sounds (a book, a university - 'you' sound). Use 'an' before words that start with vowel sounds (an apple, an hour - silent 'h'). Don't use articles with plural nouns when speaking generally (cats are animals), uncountable nouns (water, music), proper nouns (London, Mozart), or abstract concepts (love, happiness).",
                russian: "Используйте 'a' перед словами, начинающимися с согласного звука (a book, a university - звук 'ю'). Используйте 'an' перед словами, начинающимися с гласного звука (an apple, an hour - 'h' немое). Не используйте артикли с множественным числом при обобщении (cats are animals), неисчисляемыми существительными (water, music), именами собственными (London, Mozart) или абстрактными понятиями (love, happiness)."
            },
            
            // Tense configuration
            tenseConfig: {
                'present': { name: 'Present Simple', class: 'present' },
                'past': { name: 'Past Simple', class: 'past' },
                'future': { name: 'Future Simple', class: 'future' },
                'presentPerfect': { name: 'Present Perfect', class: 'present-perfect' },
                'pastPerfect': { name: 'Past Perfect', class: 'past-perfect' },
                'presentContinuous': { name: 'Present Continuous', class: 'present-continuous' },
                'pastContinuous': { name: 'Past Continuous', class: 'past-continuous' },
                'futureContinuous': { name: 'Future Continuous', class: 'future-continuous' },
                'presentPerfectContinuous': { name: 'Present Perfect Continuous', class: 'present-perfect-continuous' },
                'pastPerfectContinuous': { name: 'Past Perfect Continuous', class: 'past-perfect-continuous' }
            },
            
            // All subjects
            allSubjects: ['I', 'you', 'he', 'she', 'it', 'we', 'they'],
            
            // Russian infinitive forms
            verbInfinitives: {
                'be': 'быть',
                'beat': 'бить',
                'become': 'становиться',
                'begin': 'начинать',
                'break': 'ломать',
                'bring': 'приносить',
                'build': 'строить',
                'buy': 'покупать',
                'catch': 'ловить',
                'choose': 'выбирать',
                'come': 'приходить',
                'cost': 'стоить',
                'do': 'делать',
                'draw': 'рисовать',
                'dream': 'мечтать',
                'drink': 'пить',
                'drive': 'водить машину',
                'eat': 'есть',
                'fall': 'падать',
                'feel': 'чувствовать',
                'find': 'находить',
                'fix': 'чинить',
                'fly': 'летать',
                'get': 'получать',
                'give': 'давать',
                'go': 'идти',
                'grow': 'расти',
                'have': 'иметь',
                'hear': 'слышать',
                'know': 'знать',
                'learn': 'учиться',
                'leave': 'уходить',
                'lie': 'лежать',
                'make': 'делать',
                'meet': 'встречать',
                'play': 'играть',
                'put': 'класть',
                'read': 'читать',
                'run': 'бегать',
                'say': 'говорить',
                'see': 'видеть',
                'seek': 'искать',
                'show': 'показывать',
                'sing': 'петь',
                'sit': 'сидеть',
                'sleep': 'спать',
                'speak': 'говорить',
                'stand': 'стоять',
                'study': 'учиться',
                'swim': 'плавать',
                'take': 'брать',
                'teach': 'учить',
                'tell': 'рассказывать',
                'think': 'думать',
                'throw': 'бросать',
                'understand': 'понимать',
                'work': 'работать',
                'write': 'писать',
                'cry': 'плакать'
            },
            
            // Three forms of verbs
            verbForms: {
                'be': 'be-was/were-been',
                'beat': 'beat-beat-beaten',
                'become': 'become-became-become',
                'begin': 'begin-began-begun',
                'break': 'break-broke-broken',
                'bring': 'bring-brought-brought',
                'build': 'build-built-built',
                'buy': 'buy-bought-bought',
                'catch': 'catch-caught-caught',
                'choose': 'choose-chose-chosen',
                'come': 'come-came-come',
                'cost': 'cost-cost-cost',
                'do': 'do-did-done',
                'draw': 'draw-drew-drawn',
                'dream': 'dream-dreamt-dreamt',
                'drink': 'drink-drank-drunk',
                'drive': 'drive-drove-driven',
                'eat': 'eat-ate-eaten',
                'fall': 'fall-fell-fallen',
                'feel': 'feel-felt-felt',
                'find': 'find-found-found',
                'fix': 'fix-fixed-fixed',
                'fly': 'fly-flew-flown',
                'get': 'get-got-got',
                'give': 'give-gave-given',
                'go': 'go-went-gone',
                'grow': 'grow-grew-grown',
                'have': 'have-had-had',
                'hear': 'hear-heard-heard',
                'know': 'know-knew-known',
                'learn': 'learn-learnt-learnt',
                'leave': 'leave-left-left',
                'lie': 'lie-lay-lain',
                'make': 'make-made-made',
                'meet': 'meet-met-met',
                'play': 'play-played-played',
                'put': 'put-put-put',
                'read': 'read-read-read',
                'run': 'run-ran-run',
                'say': 'say-said-said',
                'see': 'see-saw-seen',
                'seek': 'seek-sought-sought',
                'show': 'show-showed-shown',
                'sing': 'sing-sang-sung',
                'sit': 'sit-sat-sat',
                'sleep': 'sleep-slept-slept',
                'speak': 'speak-spoke-spoken',
                'stand': 'stand-stood-stood',
                'study': 'study-studied-studied',
                'swim': 'swim-swam-swum',
                'take': 'take-took-taken',
                'teach': 'teach-taught-taught',
                'tell': 'tell-told-told',
                'think': 'think-thought-thought',
                'throw': 'throw-threw-thrown',
                'understand': 'understand-understood-understood',
                'work': 'work-worked-worked',
                'write': 'write-wrote-written',
                'cry': 'cry-cried-cried'
            },
            
            // Tense rules
            tenseRules: {
                present: {
                    english: "Used for habits, routines, general truths, and scheduled events. It describes actions that happen regularly or are always true.",
                    russian: "Используется для описания привычек, рутинных действий, общих истин и запланированных событий. Описывает действия, которые происходят регулярно или всегда верны."
                },
                past: {
                    english: "Used for completed actions in the past, past habits, and actions with a specific time. It describes things that are finished, often with a specific time or date.",
                    russian: "Используется для описания завершенных действий в прошлом, прошлых привычек и действий с указанием конкретного времени в прошлом. Описывает завершенные действия, часто с указанием конкретного времени или даты. События и факты из прошлого, следующие один за другим."
                },
                future: {
                    english: "Used for predictions, spontaneous decisions, promises, and scheduled events. It describes actions that will happen in the future, whether planned or not.",
                    russian: "Используется для предсказаний, обещаний и запланированных событий. Описывает действия, которые произойдут в будущем, запланированные или нет."
                },
                presentPerfect: {
                    english: "Used for actions that started in the past and continue to the present, actions at an unspecified time, actions connected to the present, and recent actions. It shows a link between the past and the present.",
                    russian: "Используется для действий, начавшихся в прошлом и продолжающихся в настоящем (я прожил здесь 10 лет), обозначения опыта/прецедента (я бывал в Калифорнии) и результат действий на данный момент (я сделал работу). Показывает связь между прошлым и настоящим."
                },
                pastPerfect: {
                    english: "Used for actions that happened before another action in the past or before a specific time in the past, and in reported speech. It helps sequence events in the past.",
                    russian: "Используется для действий, произошедших до другого действия в прошлом или до определенного времени в прошлом, а также в косвенной речи. Помогает упорядочить события в прошлом."
                },
                presentContinuous: {
                    english: "Used for actions happening right now, temporary situations, planned future arrangements, and annoying habits. Describes ongoing actions at the moment of speaking.",
                    russian: "Используется для действий, происходящих прямо сейчас, временных ситуаций, запланированных будущих мероприятий и раздражающих привычек. Описывает продолжающиеся действия в момент речи."
                },
                pastContinuous: {
                    english: "Used for actions that were in progress at a specific time in the past, background actions, interrupted actions, and parallel actions in the past.",
                    russian: "Используется для действий, которые происходили в определенный момент в прошлом, фоновых действий, прерванных действий и параллельных действий в прошлом."
                },
                futureContinuous: {
                    english: "Used for actions that will be in progress at a specific time in the future, polite inquiries about plans, and events that will happen as a matter of course.",
                    russian: "Используется для действий, которые будут происходить в определенный момент в будущем, вежливых вопросов о планах и событий, которые произойдут естественным образом."
                },
                presentPerfectContinuous: {
                    english: "Used for actions that started in the past and are still continuing, or have just stopped but have present results. Emphasizes the duration of the action.",
                    russian: "Используется для действий, которые начались в прошлом и все еще продолжаются, или только что закончились, но имеют результат в настоящем. Подчеркивает продолжительность действия."
                },
                pastPerfectContinuous: {
                    english: "Used for actions that had been in progress before another action or time in the past. Shows the duration of an action up to a certain point in the past.",
                    russian: "Используется для действий, которые продолжались до другого действия или момента в прошлом. Показывает продолжительность действия до определенного момента в прошлом."
                }
            },
            
            // Function to get verb data with all tense generation
            getVerbData(verb, tense, subject) {
                // Handle special verb "be"
                if (verb === 'be') {
                    return this.getBeVerbData(tense, subject);
                }
                
                // Get appropriate wh-question word
                const whWord = this.getWhQuestionWord(verb, tense);
                
                // Generate forms based on tense
                switch(tense) {
                    case 'present':
                        return this.getPresentSimple(verb, subject, whWord);
                    case 'past':
                        return this.getPastSimple(verb, subject, whWord);
                    case 'future':
                        return this.getFutureSimple(verb, subject, whWord);
                    case 'presentPerfect':
                        return this.getPresentPerfect(verb, subject, whWord);
                    case 'pastPerfect':
                        return this.getPastPerfect(verb, subject, whWord);
                    case 'presentContinuous':
                        return this.getPresentContinuous(verb, subject, whWord);
                    case 'pastContinuous':
                        return this.getPastContinuous(verb, subject, whWord);
                    case 'futureContinuous':
                        return this.getFutureContinuous(verb, subject, whWord);
                    case 'presentPerfectContinuous':
                        return this.getPresentPerfectContinuous(verb, subject, whWord);
                    case 'pastPerfectContinuous':
                        return this.getPastPerfectContinuous(verb, subject, whWord);
                    default:
                        return null;
                }
            },
            
            // Handle special verb "be"
            getBeVerbData(tense, subject) {
                const forms = {
                    present: {
                        'I': { positive: 'I am', negative: 'I am not', question: 'Am I?', whQuestion: 'Who am I?' },
                        'you': { positive: 'you are', negative: 'you are not', question: 'Are you?', whQuestion: 'Who are you?' },
                        'he': { positive: 'he is', negative: 'he is not', question: 'Is he?', whQuestion: 'Who is he?' },
                        'she': { positive: 'she is', negative: 'she is not', question: 'Is she?', whQuestion: 'Who is she?' },
                        'it': { positive: 'it is', negative: 'it is not', question: 'Is it?', whQuestion: 'What is it?' },
                        'we': { positive: 'we are', negative: 'we are not', question: 'Are we?', whQuestion: 'Who are we?' },
                        'they': { positive: 'they are', negative: 'they are not', question: 'Are they?', whQuestion: 'Who are they?' }
                    },
                    past: {
                        'I': { positive: 'I was', negative: 'I was not', question: 'Was I?', whQuestion: 'Who was I?' },
                        'you': { positive: 'you were', negative: 'you were not', question: 'Were you?', whQuestion: 'Who were you?' },
                        'he': { positive: 'he was', negative: 'he was not', question: 'Was he?', whQuestion: 'Who was he?' },
                        'she': { positive: 'she was', negative: 'she was not', question: 'Was she?', whQuestion: 'Who was she?' },
                        'it': { positive: 'it was', negative: 'it was not', question: 'Was it?', whQuestion: 'What was it?' },
                        'we': { positive: 'we were', negative: 'we were not', question: 'Were we?', whQuestion: 'Who were we?' },
                        'they': { positive: 'they were', negative: 'they were not', question: 'Were they?', whQuestion: 'Who were they?' }
                    }
                };
                
                if (forms[tense] && forms[tense][subject]) {
                    return forms[tense][subject];
                }
                
                // For other tenses, generate normally
                return null;
            },
            
            // Present Simple
            getPresentSimple(verb, subject, whWord) {
                const thirdPerson = ['he', 'she', 'it'].includes(subject);
                const verbForm = thirdPerson ? this.getThirdPersonForm(verb) : verb;
                const aux = thirdPerson ? 'does' : 'do';
                const auxNeg = thirdPerson ? "doesn't" : "don't";
                
                return {
                    positive: `${subject} ${verbForm}`,
                    negative: `${subject} ${auxNeg} ${verb}`,
                    question: `${aux.charAt(0).toUpperCase() + aux.slice(1)} ${subject} ${verb}?`,
                    whQuestion: this.formatWhQuestion(whWord, `${aux} ${subject}`, verb)
                };
            },
            
            // Past Simple
            getPastSimple(verb, subject, whWord) {
                const pastForm = this.getPastForm(verb);
                
                return {
                    positive: `${subject} ${pastForm}`,
                    negative: `${subject} didn't ${verb}`,
                    question: `Did ${subject} ${verb}?`,
                    whQuestion: this.formatWhQuestion(whWord, `did ${subject}`, verb)
                };
            },
            
            // Future Simple
            getFutureSimple(verb, subject, whWord) {
                return {
                    positive: `${subject} will ${verb}`,
                    negative: `${subject} won't ${verb}`,
                    question: `Will ${subject} ${verb}?`,
                    whQuestion: this.formatWhQuestion(whWord, `will ${subject}`, verb)
                };
            },
            
            // Present Perfect
            getPresentPerfect(verb, subject, whWord) {
                const aux = ['he', 'she', 'it'].includes(subject) ? 'has' : 'have';
                const auxNeg = ['he', 'she', 'it'].includes(subject) ? "hasn't" : "haven't";
                const pastParticiple = this.getPastParticiple(verb);
                
                return {
                    positive: `${subject} ${aux} ${pastParticiple}`,
                    negative: `${subject} ${auxNeg} ${pastParticiple}`,
                    question: `${aux.charAt(0).toUpperCase() + aux.slice(1)} ${subject} ${pastParticiple}?`,
                    whQuestion: this.formatWhQuestion(whWord, `${aux} ${subject}`, pastParticiple)
                };
            },
            
            // Past Perfect
            getPastPerfect(verb, subject, whWord) {
                const pastParticiple = this.getPastParticiple(verb);
                
                return {
                    positive: `${subject} had ${pastParticiple}`,
                    negative: `${subject} hadn't ${pastParticiple}`,
                    question: `Had ${subject} ${pastParticiple}?`,
                    whQuestion: this.formatWhQuestion(whWord, `had ${subject}`, pastParticiple)
                };
            },
            
            // Present Continuous
            getPresentContinuous(verb, subject, whWord) {
                const beForm = subject === 'I' ? 'am' : 
                             ['he', 'she', 'it'].includes(subject) ? 'is' : 'are';
                const beNeg = subject === 'I' ? 'am not' : 
                            ['he', 'she', 'it'].includes(subject) ? 'is not' : 'are not';
                const beQuestion = subject === 'I' ? 'Am' : 
                                 ['he', 'she', 'it'].includes(subject) ? 'Is' : 'Are';
                const ingForm = this.getIngForm(verb);
                
                return {
                    positive: `${subject} ${beForm} ${ingForm}`,
                    negative: `${subject} ${beNeg} ${ingForm}`,
                    question: `${beQuestion} ${subject} ${ingForm}?`,
                    whQuestion: this.formatWhQuestion(whWord, `${beForm} ${subject}`, ingForm)
                };
            },
            
            // Past Continuous
            getPastContinuous(verb, subject, whWord) {
                const wasWere = ['I', 'he', 'she', 'it'].includes(subject) ? 'was' : 'were';
                const wasWereNeg = ['I', 'he', 'she', 'it'].includes(subject) ? 'was not' : 'were not';
                const wasWereQuestion = ['I', 'he', 'she', 'it'].includes(subject) ? 'Was' : 'Were';
                const ingForm = this.getIngForm(verb);
                
                return {
                    positive: `${subject} ${wasWere} ${ingForm}`,
                    negative: `${subject} ${wasWereNeg} ${ingForm}`,
                    question: `${wasWereQuestion} ${subject} ${ingForm}?`,
                    whQuestion: this.formatWhQuestion(whWord, `${wasWere} ${subject}`, ingForm)
                };
            },
            
            // Future Continuous
            getFutureContinuous(verb, subject, whWord) {
                const ingForm = this.getIngForm(verb);
                
                return {
                    positive: `${subject} will be ${ingForm}`,
                    negative: `${subject} won't be ${ingForm}`,
                    question: `Will ${subject} be ${ingForm}?`,
                    whQuestion: this.formatWhQuestion(whWord, `will ${subject} be`, ingForm)
                };
            },
            
            // Present Perfect Continuous
            getPresentPerfectContinuous(verb, subject, whWord) {
                const aux = ['he', 'she', 'it'].includes(subject) ? 'has' : 'have';
                const auxNeg = ['he', 'she', 'it'].includes(subject) ? "hasn't" : "haven't";
                const ingForm = this.getIngForm(verb);
                
                return {
                    positive: `${subject} ${aux} been ${ingForm}`,
                    negative: `${subject} ${auxNeg} been ${ingForm}`,
                    question: `${aux.charAt(0).toUpperCase() + aux.slice(1)} ${subject} been ${ingForm}?`,
                    whQuestion: this.formatWhQuestion(whWord, `${aux} ${subject} been`, ingForm)
                };
            },
            
            // Past Perfect Continuous
            getPastPerfectContinuous(verb, subject, whWord) {
                const ingForm = this.getIngForm(verb);
                
                return {
                    positive: `${subject} had been ${ingForm}`,
                    negative: `${subject} hadn't been ${ingForm}`,
                    question: `Had ${subject} been ${ingForm}?`,
                    whQuestion: this.formatWhQuestion(whWord, `had ${subject} been`, ingForm)
                };
            },
            
            // Helper: Get third person form
            getThirdPersonForm(verb) {
                if (verb.endsWith('s') || verb.endsWith('ss') || verb.endsWith('sh') || 
                    verb.endsWith('ch') || verb.endsWith('x') || verb.endsWith('z')) {
                    return verb + 'es';
                }
                if (verb.endsWith('y') && !/[aeiou]y$/.test(verb)) {
                    return verb.slice(0, -1) + 'ies';
                }
                if (verb.endsWith('o')) {
                    return verb + 'es';
                }
                return verb + 's';
            },
            
            // Helper: Get past form
            getPastForm(verb) {
                const irregular = {
                    'go': 'went', 'do': 'did', 'have': 'had', 'see': 'saw',
                    'come': 'came', 'make': 'made', 'take': 'took', 'get': 'got',
                    'give': 'gave', 'find': 'found', 'think': 'thought', 'know': 'knew',
                    'say': 'said', 'tell': 'told', 'become': 'became', 'leave': 'left',
                    'feel': 'felt', 'bring': 'brought', 'begin': 'began', 'keep': 'kept',
                    'hold': 'held', 'write': 'wrote', 'stand': 'stood', 'hear': 'heard',
                    'let': 'let', 'mean': 'meant', 'set': 'set', 'meet': 'met',
                    'run': 'ran', 'pay': 'paid', 'sit': 'sat', 'speak': 'spoke',
                    'lie': 'lay', 'lead': 'led', 'read': 'read', 'grow': 'grew',
                    'lose': 'lost', 'fall': 'fell', 'send': 'sent', 'build': 'built',
                    'understand': 'understood', 'draw': 'drew', 'break': 'broke', 'spend': 'spent',
                    'cut': 'cut', 'rise': 'rose', 'drive': 'drove', 'buy': 'bought',
                    'wear': 'wore', 'choose': 'chose', 'seek': 'sought', 'throw': 'threw',
                    'catch': 'caught', 'deal': 'dealt', 'win': 'won', 'forget': 'forgot',
                    'lay': 'laid', 'sell': 'sold', 'fight': 'fought', 'bear': 'bore',
                    'teach': 'taught', 'sing': 'sang', 'strike': 'struck', 'hang': 'hung',
                    'shake': 'shook', 'ride': 'rode', 'feed': 'fed', 'shoot': 'shot',
                    'drink': 'drank', 'fly': 'flew', 'lead': 'led', 'swim': 'swam',
                    'eat': 'ate', 'beat': 'beat', 'cost': 'cost', 'put': 'put',
                    'shut': 'shut', 'hit': 'hit', 'hurt': 'hurt', 'sleep': 'slept',
                    'dream': 'dreamt'
                };
                
                if (irregular[verb]) return irregular[verb];
                
                // Regular verbs
                if (verb.endsWith('e')) return verb + 'd';
                if (verb.endsWith('y') && !/[aeiou]y$/.test(verb)) {
                    return verb.slice(0, -1) + 'ied';
                }
                return verb + 'ed';
            },
            
            // Helper: Get past participle
            getPastParticiple(verb) {
                const irregular = {
                    'go': 'gone', 'do': 'done', 'see': 'seen', 'make': 'made',
                    'take': 'taken', 'get': 'got', 'give': 'given', 'find': 'found',
                    'think': 'thought', 'know': 'known', 'come': 'come', 'say': 'said',
                    'tell': 'told', 'become': 'become', 'leave': 'left', 'feel': 'felt',
                    'bring': 'brought', 'begin': 'begun', 'keep': 'kept', 'hold': 'held',
                    'write': 'written', 'stand': 'stood', 'hear': 'heard', 'let': 'let',
                    'mean': 'meant', 'set': 'set', 'meet': 'met', 'run': 'run',
                    'pay': 'paid', 'sit': 'sat', 'speak': 'spoken', 'lie': 'lain',
                    'lead': 'led', 'read': 'read', 'grow': 'grown', 'lose': 'lost',
                    'fall': 'fallen', 'send': 'sent', 'build': 'built', 'understand': 'understood',
                    'draw': 'drawn', 'break': 'broken', 'spend': 'spent', 'cut': 'cut',
                    'rise': 'risen', 'drive': 'driven', 'buy': 'bought', 'wear': 'worn',
                    'choose': 'chosen', 'seek': 'sought', 'throw': 'thrown', 'catch': 'caught',
                    'deal': 'dealt', 'win': 'won', 'forget': 'forgotten', 'lay': 'laid',
                    'sell': 'sold', 'fight': 'fought', 'bear': 'borne', 'teach': 'taught',
                    'sing': 'sung', 'strike': 'struck', 'hang': 'hung', 'shake': 'shaken',
                    'ride': 'ridden', 'feed': 'fed', 'shoot': 'shot', 'drink': 'drunk',
                    'fly': 'flown', 'swim': 'swum', 'eat': 'eaten', 'beat': 'beaten',
                    'cost': 'cost', 'put': 'put', 'shut': 'shut', 'hit': 'hit',
                    'hurt': 'hurt', 'sleep': 'slept', 'dream': 'dreamt', 'have': 'had'
                };
                
                if (irregular[verb]) return irregular[verb];
                
                // Regular verbs - same as past form
                return this.getPastForm(verb);
            },
            
            // Helper: Get -ing form
            getIngForm(verb) {
                // Special cases
                const special = {
                    'be': 'being', 'die': 'dying', 'lie': 'lying', 'tie': 'tying'
                };
                
                if (special[verb]) return special[verb];
                
                // Verbs ending in -ie
                if (verb.endsWith('ie')) {
                    return verb.slice(0, -2) + 'ying';
                }
                
                // Verbs ending in -e (but not -ee, -oe, -ye)
                if (verb.endsWith('e') && !verb.endsWith('ee') && 
                    !verb.endsWith('oe') && !verb.endsWith('ye')) {
                    return verb.slice(0, -1) + 'ing';
                }
                
                // Double consonant verbs
                const doubleConsonant = ['run', 'sit', 'put', 'get', 'swim', 'stop', 'shop', 'drop', 'plan'];
                if (doubleConsonant.includes(verb)) {
                    return verb + verb[verb.length - 1] + 'ing';
                }
                
                // Default
                return verb + 'ing';
            },
            
            // Helper: Get wh-question word
            getWhQuestionWord(verb, tense) {
                const whWords = {
                    // Movement/location verbs
                    'go': 'Where', 
                    'come': 'Where', 
                    'run': 'Where',
                    'walk': 'Where',
                    'fly': 'Where',
                    'drive': 'Where',
                    'swim': 'Where',
                    'leave': 'Where',
                    'stand': 'Where',
                    'sit': 'Where',
                    'lie': 'Where',
                    'fall': 'Where',
                    'put': 'Where',
                    'sleep': 'Where',
                    
                    // Action/object verbs
                    'do': 'What',
                    'make': 'What',
                    'build': 'What',
                    'create': 'What',
                    'draw': 'What',
                    'write': 'What',
                    'cook': 'What',
                    'eat': 'What',
                    'drink': 'What',
                    'buy': 'What',
                    'sell': 'What',
                    'bring': 'What',
                    'take': 'What',
                    'give': 'What',
                    'get': 'What',
                    'find': 'What',
                    'lose': 'What',
                    'break': 'What',
                    'fix': 'What',
                    'choose': 'What',
                    'have': 'What',
                    'see': 'What',
                    'hear': 'What',
                    'read': 'What',
                    'say': 'What',
                    'tell': 'What',
                    'show': 'What',
                    'throw': 'What',
                    'catch': 'What',
                    'seek': 'What',
                    'sing': 'What',
                    'play': 'What',
                    
                    // Communication verbs
                    'speak': 'What language',
                    'talk': 'What...about',
                    'think': 'What...about',
                    'dream': 'What...about',
                    
                    // Feeling/state verbs
                    'feel': 'How',
                    'seem': 'How',
                    'appear': 'How',
                    'look': 'How',
                    'sound': 'How',
                    'grow': 'How fast',
                    
                    // Person-oriented verbs
                    'meet': 'Who',
                    'beat': 'Who',
                    'teach': 'What',  // teach something, not who
                    'help': 'Who',
                    'call': 'Who',
                    'ask': 'Who',
                    'wait': 'Who...for',
                    'love': 'Who',
                    
                    // Knowledge/understanding verbs
                    'know': 'What',  // know something
                    'understand': 'What',  // understand something
                    'tell': 'What',  // tell something
                    
                    // Time-based verbs
                    'start': 'When',
                    'begin': 'When',
                    'finish': 'When',
                    'end': 'When',
                    'arrive': 'When',
                    
                    // Cost/value verbs
                    'cost': 'How much',
                    'pay': 'How much',
                    
                    // Work/activity verbs
                    'work': 'Where',
                    'study': 'What',
                    'learn': 'What',
                    
                    // Emotion verbs
                    'cry': 'Why',
                    
                    // Special cases
                    'be': 'Who',
                    'become': 'What'
                };
                
                // For continuous tenses with duration focus
                if (tense && tense.includes('PerfectContinuous')) {
                    return 'How long';
                }
                
                return whWords[verb] || 'What';
            },
            
            // Helper: Format wh-question
            formatWhQuestion(whWord, auxPattern, verb) {
                if (!whWord || !auxPattern || !verb) {
                    return `What ${auxPattern} ${verb}?`;
                }
                
                // Special handling for verbs that need prepositions
                if (whWord.includes('...')) {
                    const parts = whWord.split('...');
                    const whPart = parts[0];
                    const prepPart = parts[1];
                    
                    // For verbs like "talk about", "think about", "wait for"
                    if (prepPart === 'about') {
                        return `${whPart} ${auxPattern} ${verb} about?`;
                    } else if (prepPart === 'for') {
                        return `${whPart} ${auxPattern} ${verb} for?`;
                    }
                    
                    return `${whPart} ${auxPattern} ${verb} ${prepPart}?`;
                }
                
                return `${whWord} ${auxPattern} ${verb}?`;
            }
        };

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
        
        // Make app available globally
        window.app = app;
    </script>
</body>
</html>
